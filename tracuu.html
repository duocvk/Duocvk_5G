<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tra cứu Trạm 5G</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
  :root{
    --bg:#eaf6ff;
    --card:#ffffff;
    --primary:#0a66c2;
    --muted:#506176;
    --installed:#fff6a3;
    --integrated:#d1eaff;
    --shadow:0 10px 30px rgba(10,30,60,0.06);
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#0b1b2b}
  header{background:linear-gradient(90deg,var(--primary),#005bb5);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
  header h1{font-size:17px;margin:0;font-weight:600}
  .container{max-width:1200px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .tabs{display:flex;gap:8px}
  .tab-btn{padding:8px 14px;border-radius:10px;border:1px solid rgba(10,30,60,0.06);background:#fff;color:var(--muted);cursor:pointer;font-weight:600}
  .tab-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 8px 22px rgba(10,80,180,0.12)}
  .logout{background:#fff;color:var(--primary);border:1px solid rgba(10,30,60,0.06);padding:8px 12px;border-radius:8px;cursor:pointer}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;position:relative;margin-top:12px}
  input[type="text"],select{padding:10px 12px;border-radius:8px;border:1px solid #e8f4ff;background:#fbfdff;min-width:180px}
  .btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--primary);border:1px solid #e8f4ff}
  #suggestions,#suggestionsCalloff{position:absolute;top:46px;left:0;background:#fff;border:1px solid #e8f4ff;border-radius:8px;box-shadow:0 8px 22px rgba(10,30,60,0.06);max-height:260px;overflow:auto;width:340px;z-index:60}
  #suggestions div,#suggestionsCalloff div{padding:8px 10px;cursor:pointer}
  #suggestions div:hover,#suggestionsCalloff div:hover{background:#f0fbff}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #eef8ff;text-align:left}
  th{background:#fbfdff;position:sticky;top:0;z-index:1}
  tr.row-installed{background:var(--installed)!important}
  tr.row-integrated{background:var(--integrated)!important}
  .map-link{color:var(--primary);text-decoration:none;font-weight:600}
  .summary-table td,.summary-table th{text-align:center}
  .detail-area{margin-top:10px;background:#fbfdff;border-radius:8px;padding:10px;border:1px solid #eef8ff}
  /* Login modal */
  .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{width:360px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 18px 40px rgba(2,6,23,0.18)}
  .modal h3{margin:0 0 10px 0}
  .modal input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #eef6ff}
  .small{font-size:13px;color:var(--muted)}
  @media(max-width:880px){
    #suggestions,#suggestionsCalloff{width:86vw;left:0}
  }
</style>
</head>
<body>
<header>
  <h1>DUOCVK_Hệ thống Tra cứu Trạm 5G_QNM</h1>
  <div>
    <button id="logoutBtn" class="logout" style="display:none">Đăng xuất</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <div class="top">
      <div class="tabs">
        <button class="tab-btn active" data-tab="chung">Tra cứu chung</button>
        <button class="tab-btn" data-tab="calloff">Calloff</button>
        <button class="tab-btn" data-tab="tong">Tổng hợp</button>
       
      </div>
      <div class="small" id="userInfo"></div>
    </div>

    <!-- Tra cứu chung -->
    <div id="panel-chung" style="margin-top:12px">
      <div class="controls">
        <div style="position:relative">
          <input id="inputChung" type="text" placeholder="Tìm mã trạm / cụm / huyện (ví dụ: 206 hoặc Tam)">
          <div id="suggestions" style="display:none"></div>
        </div>
        <select id="drop_huyen_chung"><option value="">--Huyện (A)--</option></select>
        <select id="drop_cum_chung"><option value="">--Cụm (B)--</option></select>
        <select id="drop_tram_chung"><option value="">--Trạm (C)--</option></select>
        <button id="resetChung" class="btn ghost">Reset</button>
      </div>
      <div id="table_chung"></div>
    </div>

    <!-- Calloff -->
    <div id="panel-calloff" style="margin-top:12px;display:none">
      <div class="controls">
        <select id="drop_tram_calloff"><option value="">--Chọn trạm (A)--</option></select>
        <select id="drop_huyen_calloff"><option value="">--Chọn huyện (Q)--</option></select>
        <div style="position:relative">
          <input id="inputCalloff" type="text" placeholder="Tìm trong Calloff...">
          <div id="suggestionsCalloff" style="display:none"></div>
        </div>
        <button id="resetCalloff" class="btn ghost">Reset</button>
      </div>
      <div id="table_calloff"></div>
    </div>

    <!-- Tổng hợp -->
    <div id="panel-tong" style="margin-top:12px;display:none">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btnSummaryHuyen" class="btn">Theo Huyện</button>
        <button id="btnSummaryCum" class="btn">Theo Cụm</button>
        <select id="summaryFilter"><option value="">Tất cả</option><option value="lapdat">Chỉ đã lắp</option><option value="tichhop">Chỉ đã tích hợp</option></select>
      </div>
      <div id="summaryArea" style="margin-top:12px"></div>
      <div id="summaryDetail" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<!-- Login modal (small) -->
<div id="loginModal" class="modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Đăng nhập</h3>
    <input id="loginUser" type="text" placeholder="Tên đăng nhập">
    <input id="loginPass" type="password" placeholder="Mật khẩu">
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="loginBtn" class="btn">Đăng nhập</button>
    </div>
    <p class="small" id="loginError" style="color:#c0392b"></p>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = '1Oc1rFENKMMuwG7XqqIm_MAlDi2Hkvi77m1ex5mC0N-8';
const URL_SHEET = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=sheet`;
const URL_CALLOFF = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=calloff`;

/* indices (0-based): sheet A=0,B=1,C=2,F=5,G=6,J=9,K=10 ; calloff A=0, Q=16 */
const IDX = { sheet:{huyen:0,cum:1,tram:2,lap:5,tich:6,lat:9,lng:10}, calloff:{tram:0,huyenQ:16} };

let sheetData = [], calloffData = [];

/* ================= Helper: fetch & parse GViz JSON; take header = first non-empty row = row 1 ideally ================= */
async function fetchGviz(url){
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.replace(/^[^\(]*\(/,'').replace(/\);\s*$/,''));
  const raw = (json.table.rows || []).map(r => (r.c || []).map(c => c ? c.v : ''));
  // Find first non-empty row index (prefer 0)
  let headerIndex = 0;
  for(let i=0;i<raw.length;i++){
    if(raw[i].some(cell => cell !== null && cell !== undefined && String(cell).trim() !== '')){ headerIndex = i; break; }
  }
  const header = raw[headerIndex] || [];
  const dataRows = raw.slice(headerIndex+1);
  return [header, ...dataRows];
}

/* ================= Login logic ================= */
/* New credentials: user = 'Qnm', pass = '123456' (no hint shown on popup) */
function showLogin(){ document.getElementById('loginModal').style.display = 'flex'; }
function hideLogin(){ document.getElementById('loginModal').style.display = 'none'; }
function setLoggedIn(){ document.getElementById('logoutBtn').style.display = 'inline-block'; document.getElementById('userInfo').textContent = 'Xin chào, Qnm'; }

window.addEventListener('load', ()=>{
  if(localStorage.getItem('tc_logged')==='1'){ hideLogin(); setLoggedIn(); startApp(); } else showLogin();
});

document.getElementById('loginBtn').addEventListener('click', ()=>{
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if(u === 'Qnm' && p === '123456'){
    localStorage.setItem('tc_logged','1');
    hideLogin(); setLoggedIn(); startApp();
  } else {
    document.getElementById('loginError').textContent = 'Sai tên đăng nhập hoặc mật khẩu';
  }
});

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('tc_logged'); location.reload();
});

/* ================= Tabs ================= */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    document.getElementById('panel-chung').style.display = tab==='chung' ? 'block' : 'none';
    document.getElementById('panel-calloff').style.display = tab==='calloff' ? 'block' : 'none';
    document.getElementById('panel-tong').style.display = tab==='tong' ? 'block' : 'none';
    document.getElementById('panel-lapdat').style.display = tab==='tong' ? 'block' : 'none';
    hideSuggestions(); hideSuggestionsCalloff();
  });
});

/* ================= Start app: load sheets then init UI ================= */
async function startApp(){
  try{
    sheetData = await fetchGviz(URL_SHEET);
    calloffData = await fetchGviz(URL_CALLOFF);
  } catch(err){
    alert('Lỗi tải Google Sheet. Kiểm tra quyền chia sẻ (Anyone with link → Viewer).');
    console.error(err);
    return;
  }
  setupChung();
  setupCalloff();
  renderSummary('huyen');
}

/* ================= Utilities ================= */
function esc(s){ return String(s===undefined||s===null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function isOne(v){ return v === 1 || v === '1' || v === true; }

/* ================= Tra cứu chung ================= */
function setupChung(){
  fillSelectUnique(sheetData, IDX.sheet.huyen, '#drop_huyen_chung', '--Huyện (A)--');
  fillSelectUnique(sheetData, IDX.sheet.cum, '#drop_cum_chung', '--Cụm (B)--');
  fillSelectUnique(sheetData, IDX.sheet.tram, '#drop_tram_chung', '--Trạm (C)--');

  const input = document.getElementById('inputChung'), box = document.getElementById('suggestions');

  input.addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase();
    box.innerHTML = '';
    if(!q){ box.style.display='none'; return; }
    const found = new Set();
    const rows = sheetData.slice(1);
    for(let r of rows){
      [IDX.sheet.tram, IDX.sheet.cum, IDX.sheet.huyen].forEach(ci=>{
        const v = r[ci]; if(v && String(v).toLowerCase().includes(q)) found.add(String(v));
      });
      if(found.size >= 40) break;
    }
    Array.from(found).slice(0,30).forEach(s=>{
      const d = document.createElement('div'); d.textContent = s;
      d.onclick = ()=>{
        // when selecting suggestion: apply filter immediately and clear input
        input.value = '';
        box.innerHTML = '';
        box.style.display = 'none';
        filterChungByKeyword(s);
      };
      box.appendChild(d);
    });
    box.style.display = found.size ? 'block' : 'none';
  });

  document.getElementById('drop_huyen_chung').addEventListener('change', applyChungFilters);
  document.getElementById('drop_cum_chung').addEventListener('change', applyChungFilters);
  document.getElementById('drop_tram_chung').addEventListener('change', applyChungFilters);

  document.getElementById('resetChung').addEventListener('click', ()=>{
    document.getElementById('inputChung').value = '';
    document.getElementById('drop_huyen_chung').value = '';
    document.getElementById('drop_cum_chung').value = '';
    document.getElementById('drop_tram_chung').value = '';
    drawChungRows(sheetData.slice(1));
    hideSuggestions();
  });

  drawChungRows(sheetData.slice(1));
}

function hideSuggestions(){ const b = document.getElementById('suggestions'); b.style.display = 'none'; b.innerHTML = ''; }
function hideSuggestionsCalloff(){ const b = document.getElementById('suggestionsCalloff'); b.style.display = 'none'; b.innerHTML = ''; }

function fillSelectUnique(rows, col, sel, placeholder){
  const set = new Set();
  for(let i=1;i<rows.length;i++){
    const v = rows[i][col];
    if(v !== undefined && v !== null && String(v).trim() !== '') set.add(String(v));
  }
  const arr = Array.from(set).sort();
  const el = document.querySelector(sel);
  if(!el) return;
  el.innerHTML = `<option value="">${placeholder}</option>`;
  arr.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; el.appendChild(o); });
}

function applyChungFilters(){
  let rows = sheetData.slice(1);
  const h = document.getElementById('drop_huyen_chung').value;
  const c = document.getElementById('drop_cum_chung').value;
  const t = document.getElementById('drop_tram_chung').value;
  if(h) rows = rows.filter(r => String(r[IDX.sheet.huyen]) === String(h));
  if(c) rows = rows.filter(r => String(r[IDX.sheet.cum]) === String(c));
  if(t) rows = rows.filter(r => String(r[IDX.sheet.tram]) === String(t));
  drawChungRows(rows);
}

function filterChungByKeyword(keyword){
  const q = String(keyword).toLowerCase();
  const rows = sheetData.slice(1).filter(r => r.some(cell => cell && String(cell).toLowerCase().includes(q)));
  drawChungRows(rows);
}

function drawChungRows(rows){
  const header = sheetData[0] || [];
  const lat = IDX.sheet.lat, lng = IDX.sheet.lng;
  let html = '<table><thead><tr>';
  for(let i=0;i<header.length;i++){
    if(i===lat || i===lng) continue;
    html += `<th>${esc(header[i]||'')}</th>`;
  }
  html += '<th>Bản đồ</th></tr></thead><tbody>';
  for(let r of rows){
    const f = r[IDX.sheet.lap], g = r[IDX.sheet.tich];
    const cls = isOne(f) && isOne(g) ? 'row-integrated' : (isOne(f) ? 'row-installed' : '');
    html += `<tr class="${cls}">`;
    for(let i=0;i<header.length;i++){
      if(i===lat || i===lng) continue;
      html += `<td>${esc(r[i]===undefined?'':r[i])}</td>`;
    }
    const latv = r[lat], lngv = r[lng], tram = r[IDX.sheet.tram] || '';
    if(latv !== undefined && lngv !== undefined && String(latv).trim() !== '' && String(lngv).trim() !== ''){
      html += `<td><a class="map-link" target="_blank" href="https://www.google.com/maps?q=${latv},${lngv} (${encodeURIComponent(tram)})">Xem</a></td>`;
    } else {
      html += '<td></td>';
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById('table_chung').innerHTML = html;
}

/* ================= Calloff ================= */
function setupCalloff(){
  fillSelectUnique(calloffData, IDX.calloff.tram, '#drop_tram_calloff', '--Trạm (A)--');
  if(calloffData[0] && calloffData[0].length > IDX.calloff.huyenQ) fillSelectUnique(calloffData, IDX.calloff.huyenQ, '#drop_huyen_calloff', '--Huyện (Q)--');
  else document.getElementById('drop_huyen_calloff').innerHTML = '<option value="">--Huyện (Q)--</option>';

  document.getElementById('inputCalloff').addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase();
    const box = document.getElementById('suggestionsCalloff'); box.innerHTML = '';
    if(!q){ box.style.display='none'; return; }
    const found = new Set();
    for(let i=1;i<calloffData.length;i++){
      const r = calloffData[i];
      [IDX.calloff.tram, IDX.calloff.huyenQ].forEach(ci=>{
        if(ci < r.length){
          const v = r[ci];
          if(v && String(v).toLowerCase().includes(q)) found.add(String(v));
        }
      });
      if(found.size>=40) break;
    }
    Array.from(found).slice(0,30).forEach(s=>{
      const d = document.createElement('div'); d.textContent = s;
      d.onclick = ()=>{ e.target.value=''; box.innerHTML=''; box.style.display='none'; filterCalloffByKeyword(s); };
      box.appendChild(d);
    });
    box.style.display = found.size ? 'block' : 'none';
  });

  document.getElementById('drop_tram_calloff').addEventListener('change', function(){ const v=this.value; if(!v) drawCalloffRows(calloffData.slice(1)); else filterCalloffByKeyword(v); });
  document.getElementById('drop_huyen_calloff').addEventListener('change', function(){ const v=this.value; if(!v) drawCalloffRows(calloffData.slice(1)); else filterCalloffByKeyword(v); });

  document.getElementById('resetCalloff').addEventListener('click', ()=>{
    document.getElementById('inputCalloff').value = '';
    document.getElementById('drop_tram_calloff').value = '';
    document.getElementById('drop_huyen_calloff').value = '';
    drawCalloffRows(calloffData.slice(1));
    hideSuggestionsCalloff();
  });

  drawCalloffRows(calloffData.slice(1));
}

function filterCalloffByKeyword(k){
  const q = String(k).toLowerCase();
  const rows = calloffData.slice(1).filter(r => r.some(cell => cell && String(cell).toLowerCase().includes(q)));
  drawCalloffRows(rows);
}

function drawCalloffRows(rows){
  const header = calloffData[0] || [];
  let html = '<table><thead><tr>';
  header.forEach(h => html += `<th>${esc(h||'')}</th>`);
  html += '</tr></thead><tbody>';
  for(let r of rows){
    html += '<tr>';
    for(let i=0;i<header.length;i++) html += `<td>${esc(r[i]===undefined?'':r[i])}</td>`;
    html += '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById('table_calloff').innerHTML = html;
}

/* ================= Summary with expandable detail ================= */
document.getElementById('btnSummaryHuyen').addEventListener('click', ()=>renderSummary('huyen'));
document.getElementById('btnSummaryCum').addEventListener('click', ()=>renderSummary('cum'));
document.getElementById('summaryFilter').addEventListener('change', ()=>{ const mode = document.getElementById('summaryArea').dataset.mode || 'huyen'; renderSummary(mode); });

function renderSummary(mode){
  if(!sheetData || sheetData.length < 2) return;
  const rows = sheetData.slice(1);
  const col = mode === 'huyen' ? IDX.sheet.huyen : IDX.sheet.cum;
  const groups = new Map();
  for(let i=0;i<rows.length;i++){
    const key = rows[i][col] || '(Không xác định)';
    if(!groups.has(key)) groups.set(key, {total:0,lap:0,tich:0,indices:[]});
    const g = groups.get(key); g.total++; if(isOne(rows[i][IDX.sheet.lap])) g.lap++; if(isOne(rows[i][IDX.sheet.tich])) g.tich++; g.indices.push(i);
  }
  let html = '<table class="summary-table"><thead><tr><th>STT</th><th>' + (mode==='huyen'?'Huyện':'Cụm') + '</th><th>Tổng</th><th>Đã lắp</th><th>Đã tích hợp</th><th>% Lắp</th><th>% Tích hợp</th><th>Chi tiết</th></tr></thead><tbody>';
  let idx=0;
  Array.from(groups.entries()).sort((a,b)=>b[1].total - a[1].total).forEach(([k,v])=>{
    idx++;
    const pL = v.total ? Math.round(v.lap*100/v.total) : 0;
    const pT = v.total ? Math.round(v.tich*100/v.total) : 0;
    const gid = 'grp-'+encodeURIComponent(k);
    html += `<tr id="${gid}"><td style="text-align:center">${idx}</td><td>${esc(k)}</td><td style="text-align:center">${v.total}</td><td style="text-align:center">${v.lap}</td><td style="text-align:center">${v.tich}</td><td style="text-align:center">${pL}%</td><td style="text-align:center">${pT}%</td><td style="text-align:center"><button class="btn" onclick="toggleDetail('${encodeURIComponent(k)}','${mode}')">Xem chi tiết</button></td></tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('summaryArea').innerHTML = html;
  document.getElementById('summaryArea').dataset.mode = mode;
  document.getElementById('summaryDetail').innerHTML = '';
}

function toggleDetail(encKey, mode){
  const key = decodeURIComponent(encKey);
  const detailId = 'detail-'+encKey;
  const existing = document.getElementById(detailId);
  if(existing){ existing.remove(); return; }
  const col = mode==='huyen' ? IDX.sheet.huyen : IDX.sheet.cum;
  const rows = sheetData.slice(1).filter(r => String(r[col]||'') === key);
  const filterOpt = document.getElementById('summaryFilter').value;
  let rowsToShow = rows;
  if(filterOpt === 'lapdat') rowsToShow = rows.filter(r => isOne(r[IDX.sheet.lap]));
  if(filterOpt === 'tichhop') rowsToShow = rows.filter(r => isOne(r[IDX.sheet.tich]));

  const header = sheetData[0] || []; const lat = IDX.sheet.lat, lng = IDX.sheet.lng;
  let html = `<div id="${detailId}" class="detail-area"><table><thead><tr>`;
  for(let i=0;i<header.length;i++){ if(i===lat||i===lng) continue; html += `<th>${esc(header[i]||'')}</th>`; }
  html += `<th>Bản đồ</th></tr></thead><tbody>`;
  rowsToShow.forEach(r=>{
    const cls = isOne(r[IDX.sheet.lap]) && isOne(r[IDX.sheet.tich]) ? 'row-integrated' : (isOne(r[IDX.sheet.lap]) ? 'row-installed' : '');
    html += `<tr class="${cls}">`;
    for(let i=0;i<header.length;i++){ if(i===lat||i===lng) continue; html += `<td>${esc(r[i]===undefined?'':r[i])}</td>`; }
    const latv = r[lat], lngv = r[lng], tram = r[IDX.sheet.tram] || '';
    if(latv && lngv) html += `<td><a class="map-link" target="_blank" href="https://www.google.com/maps?q=${latv},${lngv} (${encodeURIComponent(tram)})">Xem</a></td>`; else html += '<td></td>';
    html += '</tr>';
  });
  html += '</tbody></table></div>';

  const groupRow = document.getElementById('grp-'+encodeURIComponent(key));
  if(groupRow){ const wrapper = document.createElement('div'); wrapper.innerHTML = html; groupRow.parentNode.insertBefore(wrapper, groupRow.nextSibling); wrapper.scrollIntoView({behavior:'smooth', block:'start'}); }
  else document.getElementById('summaryDetail').innerHTML = html;
}

/* ================= End ================= */
</script>


<!-- ================= Tab Error ================= -->
<script>
const URL_ERROR = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=error`;
let errorData = [];

/* ================= Fetch dữ liệu Error ================= */
async function fetchErrorSheet(){
  try{
    errorData = await fetchGviz(URL_ERROR);
  } catch(err){
    console.error('Lỗi tải sheet error', err);
  }
}

/* ================= Thêm tab Error vào header ================= */
window.addEventListener('load', async ()=>{
  await fetchErrorSheet();

  // thêm nút tab Error
  const tabContainer = document.querySelector('.tabs');
  if(tabContainer){
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.setAttribute('data-tab','error');
    btn.textContent = 'Lỗi theo trạm';
    tabContainer.appendChild(btn);

    // thêm panel Error
    const container = document.querySelector('.container .card');
    const panel = document.createElement('div');
    panel.id = 'panel-error';
    panel.style.display = 'none';
    panel.style.marginTop = '12px';
    panel.innerHTML = `
      <div class="controls" style="position:relative">
        <input id="inputError" type="text" placeholder="Nhập mã trạm cần tìm..." style="flex-grow:1;min-width:220px;padding:10px;border-radius:8px;border:1px solid #e8f4ff;background:#fbfdff;">
        <div id="suggestionsError" style="position:absolute;top:46px;left:0;background:#fff;border:1px solid #e8f4ff;border-radius:8px;box-shadow:0 8px 22px rgba(10,30,60,0.06);max-height:260px;overflow:auto;width:340px;z-index:60;display:none"></div>
        <button id="btnErrorReset" class="btn ghost">Reset</button>
      </div>
      <div id="errorResult" style="margin-top:12px"></div>
    `;
    container.appendChild(panel);

    // click tab
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      // ẩn các panel khác
      document.getElementById('panel-chung').style.display = 'none';
      document.getElementById('panel-calloff').style.display = 'none';
      document.getElementById('panel-tong').style.display = 'none';
      document.getElementById('panel-error').style.display = 'block';
       document.getElementById('panel-lapdat').style.display = 'none';

      // reset khi mở tab
      document.getElementById('inputError').value = '';
      document.getElementById('errorResult').innerHTML = '';
      hideSuggestionsError();
    });

    // input + gợi ý
    const input = document.getElementById('inputError');
    const box = document.getElementById('suggestionsError');
    const result = document.getElementById('errorResult');

    input.addEventListener('input', ()=>{
      const q = input.value.trim().toLowerCase();
      box.innerHTML = '';
      if(!q){ box.style.display='none'; return; }

      const found = new Set();
      for(let i=1;i<errorData.length;i++){
        const r = errorData[i];
        const tram = r[0];
        if(tram && String(tram).toLowerCase().includes(q)) found.add(tram);
        if(found.size>=40) break;
      }

      Array.from(found).slice(0,30).forEach(s=>{
        const d = document.createElement('div');
        d.textContent = s;
        d.style.cursor = 'pointer';
        d.onclick = ()=>{
          input.value = '';
          box.innerHTML = '';
          box.style.display = 'none';
          showErrors(s);
        };
        box.appendChild(d);
      });
      box.style.display = found.size ? 'block' : 'none';
    });

    function hideSuggestionsError(){ box.style.display='none'; box.innerHTML=''; }

    // reset nút
    document.getElementById('btnErrorReset').addEventListener('click', ()=>{
      input.value = '';
      result.innerHTML = '';
      hideSuggestionsError();
    });
  }
});

/* ================= Hàm showErrors ================= */
function showErrors(tram){
  if(!errorData || errorData.length < 2){
    document.getElementById('errorResult').innerHTML = 'Dữ liệu lỗi chưa sẵn sàng!';
    return;
  }

  const rows = errorData.slice(1).filter(r => String(r[0]||'') === tram);
  const result = document.getElementById('errorResult');

  if(!rows.length){
    result.innerHTML = `<div>Trạm ${tram} không tồn lỗi nào!</div>`;
    return;
  }

  const headerRow = errorData[0]; // Dòng 1
  let messages = [];

  rows.forEach(r=>{
    for(let col=3; col<=20; col++){ // D->U
      const cell = r[col];
      if(cell && (String(cell).toLowerCase() === 'e')){
        messages.push(headerRow[col] || `Cột ${col+1}`);
      }
    }
  });

  if(messages.length){
    let html = `<div>Trạm ${tram} tồn lỗi:</div><ul>`;
    messages.forEach(m=> html += `<li>${m}</li>`);
    html += '</ul>';
    result.innerHTML = html;
  } else {
    result.innerHTML = `<div>Trạm ${tram} không tồn lỗi nào!</div>`;
  }
}
</script>
  

<!-- Chèn trực tiếp vào div.tabs cùng các tab khác -->
<button class="tab-btn" data-tab="loiChiTiet">Lỗi chi tiết</button>

<!-- Panel Lỗi chi tiết -->
<div id="panel-loiChiTiet" style="margin-top:12px;display:none">
  <div class="controls">
    <div style="position:relative">
      <input id="inputLoiChiTiet" type="text" placeholder="Tìm lỗi...">
      <div id="suggestionsLoiChiTiet" style="display:none"></div>
    </div>
    <button id="resetLoiChiTiet" class="btn ghost">Reset</button>
  </div>
  <div id="summaryLoiChiTiet" style="margin-top:12px"></div>
  <div id="tableLoiChiTiet" style="margin-top:12px"></div>
</div>

<script>
async function setupLoiChiTietTab() {
  // Fetch sheet error khi load
  if(!errorData || errorData.length===0){
    try{
      const res = await fetch(URL_ERROR);
      const text = await res.text();
      const json = JSON.parse(text.replace(/^[^\(]*\(/,'').replace(/\);\s*$/,''));
      errorData = (json.table.rows || []).map(r => (r.c || []).map(c => c ? c.v : ''));
    } catch(err){
      console.error('Lỗi fetch sheet error:', err);
      return;
    }
  }

  const input = document.getElementById('inputLoiChiTiet');
  const box = document.getElementById('suggestionsLoiChiTiet');
  const table = document.getElementById('tableLoiChiTiet');
  const summary = document.getElementById('summaryLoiChiTiet');

  const errorHeader = errorData[0].slice(3,21); // D1→U1
  const colHeader = errorData[0].slice(0,3); // A,B,C
  const colHuyenIdx = 1; // cột B = huyện

  function hideSuggestions(){ box.style.display='none'; box.innerHTML=''; }

  input.addEventListener('input', e => {
    const q = e.target.value.trim().toLowerCase();
    box.innerHTML = '';
    if(!q){ hideSuggestions(); return; }
    const found = errorHeader.filter(h => h && h.toLowerCase().includes(q)).slice(0,30);
    found.forEach(s => {
      const d = document.createElement('div'); 
      d.textContent = s;
      d.onclick = ()=>showLoiChiTiet(s);
      box.appendChild(d);
    });
    box.style.display = found.length ? 'block' : 'none';
  });

  document.getElementById('resetLoiChiTiet').addEventListener('click', ()=>{
    input.value=''; table.innerHTML=''; summary.innerHTML=''; hideSuggestions();
  });

  function showLoiChiTiet(selectedHeader){
    hideSuggestions();
    input.value='';
    table.innerHTML=''; summary.innerHTML='';

    const idx = errorData[0].indexOf(selectedHeader);
    if(idx === -1){ table.innerHTML='Không tìm thấy lỗi'; return; }

    const rows = errorData.slice(1).filter(r => r[idx] && String(r[idx]).toLowerCase() === 'e');
rows.sort((a,b) => ((a[1]||'').toLowerCase()).localeCompare((b[1]||'').toLowerCase()));
    if(rows.length===0){
      table.innerHTML = `<p>Lỗi: <b>${selectedHeader}</b></p>Không có trạm nào bị lỗi này`;
      return;
    }

    // ===== Bảng tổng hợp theo huyện =====
    const summaryMap = new Map();
    rows.forEach(r=>{
      const huyen = r[colHuyenIdx] || '(Không xác định)';
      summaryMap.set(huyen, (summaryMap.get(huyen)||0)+1);
    });

    const entries = Array.from(summaryMap.entries());
    let sumHtml = `<p style="font-weight:bold;">Lỗi: <b>${selectedHeader}</b> : ${rows.length}</p>`;
    sumHtml += '<table style="border-collapse:collapse;width:auto;margin-bottom:8px;"><thead><tr style="background:#ffcdcb;color:#000;font-weight:bold;">';
    sumHtml += '<th style="padding:4px 6px;border:1px solid #999">Huyện</th><th style="padding:4px 6px;border:1px solid #999">Số lỗi</th>';
    if(entries.length>3){ sumHtml += '<th style="padding:4px 6px;border:1px solid #999">Huyện</th><th style="padding:4px 6px;border:1px solid #999">Số lỗi</th>'; }
    sumHtml += '</tr></thead><tbody>';
    for(let i=0;i<entries.length;i+=2){
      const first = entries[i];
      const second = entries[i+1];
      sumHtml += '<tr>';
      sumHtml += `<td style="padding:4px 6px;border:1px solid #999">${esc(first[0])}</td><td style="padding:4px 6px;border:1px solid #999;text-align:center">${first[1]}</td>`;
      if(second){ 
        sumHtml += `<td style="padding:4px 6px;border:1px solid #999">${esc(second[0])}</td><td style="padding:4px 6px;border:1px solid #999;text-align:center">${second[1]}</td>`;
      } else if(entries.length>3){ 
        sumHtml += '<td></td><td></td>'; 
      }
      sumHtml += '</tr>';
    }
    sumHtml += '</tbody></table>';
    summary.innerHTML = sumHtml;

    // ===== Bảng chi tiết 3 cột =====
    let html = '<table style="border-collapse:collapse;width:auto;"><thead><tr style="background:#ffcdcb;color:#000;font-weight:bold;">';
    colHeader.forEach(h=>html+=`<th style="padding:4px 6px;border:1px solid #999">${esc(h||'')}</th>`);
    html += '</tr></thead><tbody>';
    rows.forEach((r,i)=>{
      const bg = i%2===0?'#f0f8ff':'#ffffff';
      html += `<tr style="background:${bg}">`;
      html += `<td style="padding:3px 6px;border:1px solid #999">${esc(r[0]||'')}</td>`;
      html += `<td style="padding:3px 6px;border:1px solid #999">${esc(r[1]||'')}</td>`;
      html += `<td style="padding:3px 6px;border:1px solid #999">${esc(r[2]||'')}</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';
    table.innerHTML = html;
  }

  // Tab click show/hide panel
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.getAttribute('data-tab');
      document.getElementById('panel-chung').style.display = tab==='chung' ? 'block' : 'none';
      document.getElementById('panel-calloff').style.display = tab==='calloff' ? 'block' : 'none';
      document.getElementById('panel-tong').style.display = tab==='tong' ? 'block' : 'none';
      document.getElementById('panel-error').style.display = tab==='error' ? 'block' : 'none';
      document.getElementById('panel-loiChiTiet').style.display = tab==='loiChiTiet' ? 'block' : 'none';
      hideSuggestions(); hideSuggestionsCalloff(); hideSuggestionsLoiChiTiet();
    });
  });

  function hideSuggestionsLoiChiTiet(){ box.style.display='none'; box.innerHTML=''; }
}
window.addEventListener('load', setupLoiChiTietTab);
</script>



<!-- Thêm nút tab Lắp đặt -->
<script>
window.addEventListener('load', async () => {
  const tabContainer = document.querySelector('.tabs');
  const cardContainer = document.querySelector('.container .card');
  if (!tabContainer || !cardContainer) return;

  // Thêm nút tab Lắp đặt
  const btn = document.createElement('button');
  btn.className = 'tab-btn';
  btn.setAttribute('data-tab', 'lapdat');
  btn.textContent = 'Lắp đặt';
  tabContainer.appendChild(btn);

  // Tạo panel riêng cho Lắp đặt
  const panel = document.createElement('div');
  panel.id = 'panel-lapdat';
  panel.style.display = 'none';
  panel.style.marginTop = '12px';
  panel.innerHTML = `
    <div class="controls">
      <select id="filterHuyenCum">
        <option value="huyen">Chọn Huyện</option>
        <option value="cum">Chọn Cụm</option>
      </select>
      <select id="filterDoiTac">
        <option value="all">Tất cả</option>
        <option value="VCTL">VCTL</option>
        <option value="VCC">VCC</option>
      </select>
      <select id="filterLapDat">
        <option value="all">Tất cả</option>
        <option value="1">Đã lắp đặt</option>
        <option value="0">Chưa lắp đặt</option>
      </select>
      <select id="filterTichHop">
        <option value="all">Tất cả</option>
        <option value="1">Đã tích hợp</option>
        <option value="0">Chưa tích hợp</option>
      </select>
      <button id="resetLapDat" class="btn ghost">Reset</button>
    </div>
    <div id="tableLapDat" style="margin-top:12px"></div>
  `;
  cardContainer.appendChild(panel);

  // Click tab
//  btn.addEventListener('click', () => {
//    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
 //   btn.classList.add('active');
    // Ẩn tất cả panel khác
 //   document.querySelectorAll('#panel-chung,#panel-calloff,#panel-tong,#panel-error,#panel-loiChiTiet,#panel-lapdat').forEach(p => p.style.display = 'none');
 //   panel.style.display = 'block';
 // });



  
//BẮT ĐẦU ĐOẠN CODE SỬA
  
// Click tab Lắp đặt
btn.addEventListener('click', () => {
  // Active tab
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  // Ẩn tất cả panel khác, kể cả panel Lắp đặt
  const allPanels = document.querySelectorAll('#panel-chung,#panel-calloff,#panel-tong,#panel-error,#panel-loiChiTiet,#panel-lapdat');
  allPanels.forEach(p => p.style.display = 'none');

  // Hiện panel Lắp đặt
  panel.style.display = 'block';
});

 // KẾT THÚC ĐOẠN SỬA CODE ẨN PANEL
  
  // Load dữ liệu từ sheet lapdat
  const SHEET_LAPDAT = 'lapdat';
  let lapdatData = [];
  try {
    const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_LAPDAT}`);
    const text = await res.text();
    const json = JSON.parse(text.replace(/^[^\(]*\(/, '').replace(/\);\s*$/, ''));
    lapdatData = (json.table.rows || []).map(r => (r.c || []).map(c => c ? c.v : ''));
  } catch (err) {
    console.error('Lỗi load sheet lapdat', err);
    return;
  }

  // Hiển thị bảng
  const tableDiv = document.getElementById('tableLapDat');
  const filterHuyenCum = document.getElementById('filterHuyenCum');
  const filterDoiTac = document.getElementById('filterDoiTac');
  const filterLapDat = document.getElementById('filterLapDat');
  const filterTichHop = document.getElementById('filterTichHop');
  const resetBtn = document.getElementById('resetLapDat');

  function renderTable() {
    if (!lapdatData || lapdatData.length < 2) return;

    // Dòng 1 là tiêu đề, dòng 2 trở đi là dữ liệu
    const header = lapdatData[0];
    let rows = lapdatData.slice(1);

    // Filter theo lựa chọn
    const dt = filterDoiTac.value;
    if (dt !== 'all') rows = rows.filter(r => String(r[6] || '').toUpperCase() === dt);

    const ld = filterLapDat.value;
    if (ld !== 'all') rows = rows.filter(r => (String(r[4] || '') === '1' && ld === '1') || (String(r[4] || '') !== '1' && ld === '0'));

    const th = filterTichHop.value;
    if (th !== 'all') rows = rows.filter(r => (String(r[5] || '') === '1' && th === '1') || (String(r[5] || '') !== '1' && th === '0'));

    // Nhóm theo Huyện/Cụm
    const groupCol = filterHuyenCum.value === 'huyen' ? 0 : 1;
    const groups = new Map();
    rows.forEach(r => {
      const key = r[groupCol] || '(Không xác định)';
      if (!groups.has(key)) groups.set(key, { total: 0, lap: 0, tich: 0, rows: [] });
      const g = groups.get(key);
      g.total++;
      g.lap += String(r[4] || '') === '1' ? 1 : 0;
      g.tich += String(r[5] || '') === '1' ? 1 : 0;
      g.rows.push(r);
    });

    // Sort keys
    const keys = Array.from(groups.keys()).sort((a, b) => a.localeCompare(b));

    // Tạo HTML bảng
    let html = '<table class="summary-table" style="border-collapse:collapse;width:100%"><thead><tr style="background:#eee">';
    html += `<th style="border:1px solid #999;padding:4px">STT</th>`;
    html += `<th style="border:1px solid #999;padding:4px">${groupCol === 0 ? 'Huyện' : 'Cụm'}</th>`;
    html += `<th style="border:1px solid #999;padding:4px">Tổng số trạm</th>`;
    html += `<th style="border:1px solid #999;padding:4px">Đã lắp</th>`;
    html += `<th style="border:1px solid #999;padding:4px">Đã tích hợp</th>`;
    html += `<th style="border:1px solid #999;padding:4px">Chi tiết</th>`;
    html += '</tr></thead><tbody>';

    // Tổng
   // let totalAll = 0, lapAll = 0, tichAll = 0;
   // keys.forEach(k => {
   //   const g = groups.get(k);
   //   totalAll += g.total;
    //  lapAll += g.lap;
    //  tichAll += g.tich;
   // });
   // html += `<tr style="font-weight:bold;background:#ffd"><td></td><td>Tổng</td><td style="text-align:center;border:1px solid #999">${totalAll}</td><td style="text-align:center;border:1px solid #999">${lapAll}</td><td style="text-align:center;border:1px solid #999">${tichAll}</td><td></td></tr>`;
let totalAll = 0, lapAll = 0, tichAll = 0;
keys.forEach(k => {
  const g = groups.get(k);
  totalAll += g.total;
  lapAll += g.lap;
  tichAll += g.tich;
});
html += `<tr style="font-weight:bold;background:#ffd">
  <td></td>
  <td>Tổng</td>
  <td style="text-align:center;border:1px solid #999">${totalAll}</td>
  <td style="text-align:center;border:1px solid #999">${lapAll}</td>
  <td style="text-align:center;border:1px solid #999">${tichAll}</td>
  <td style="text-align:center;border:1px solid #999">
    <button class="btn" onclick="showModalLapDat('all','Tổng')">Xem</button>
  </td>
</tr>`;


    
    // Các dòng dữ liệu
    keys.forEach((k, i) => {
      const g = groups.get(k);
      html += `<tr>`;
      html += `<td style="text-align:center;border:1px solid #999;padding:3px">${i + 1}</td>`;
      html += `<td style="border:1px solid #999;padding:3px">${k}</td>`;
      html += `<td style="text-align:center;border:1px solid #999;padding:3px">${g.total}</td>`;
      html += `<td style="text-align:center;border:1px solid #999;padding:3px">${g.lap}</td>`;
      html += `<td style="text-align:center;border:1px solid #999;padding:3px">${g.tich}</td>`;
      html += `<td style="text-align:center;border:1px solid #999;padding:3px"><button class="btn" onclick="showModalLapDat('${groupCol}','${k}')">Xem</button></td>`;
      html += `</tr>`;
    });
    html += '</tbody></table>';
    tableDiv.innerHTML = html;
  }

  [filterHuyenCum, filterDoiTac, filterLapDat, filterTichHop].forEach(el => el.addEventListener('change', renderTable));
  resetBtn.addEventListener('click', () => {
    filterHuyenCum.value = 'huyen';
    filterDoiTac.value = 'all';
    filterLapDat.value = 'all';
    filterTichHop.value = 'all';
    renderTable();
  });

  renderTable();

  // Modal chi tiết
  window.showModalLapDat = function (groupCol, key) {
    const gkey = key === '(Không xác định)' ? '' : key;

    // Lọc dữ liệu theo các filter
    let rows = lapdatData.slice(1);
    const dt = filterDoiTac.value;
    const ld = filterLapDat.value;
    const th = filterTichHop.value;

    rows = rows.filter(r => {
  const condDT = dt === 'all' || String(r[6] || '').toUpperCase() === dt;
  const condLD = ld === 'all' || (String(r[4] || '') === '1' && ld === '1') || (String(r[4] || '') !== '1' && ld === '0');
  const condTH = th === 'all' || (String(r[5] || '') === '1' && th === '1') || (String(r[5] || '') !== '1' && th === '0');

  if(groupCol === 'all') return condDT && condLD && condTH; // tổng tất cả
  const matchCol = r[groupCol] || '';
  const gkey = key === '(Không xác định)' ? '' : key;
  const condHuyenCum = matchCol === gkey;
  return condHuyenCum && condDT && condLD && condTH;
});

   // rows = rows.filter(r => {
   //   const matchCol = r[groupCol] || '';
   //   const condHuyenCum = matchCol === gkey;
   //   const condDT = dt === 'all' || String(r[6] || '').toUpperCase() === dt;
   //   const condLD = ld === 'all' || (String(r[4] || '') === '1' && ld === '1') || (String(r[4] || '') !== '1' && ld === '0');
  //    const condTH = th === 'all' || (String(r[5] || '') === '1' && th === '1') || (String(r[5] || '') !== '1' && th === '0');
  //    return condHuyenCum && condDT && condLD && condTH;
  //  });

    let html = `<table style="width:100%;border-collapse:collapse"><thead><tr>`;
    lapdatData[0].forEach(h => html += `<th style="border:1px solid #999;padding:4px">${h || ''}</th>`);
    html += '</tr></thead><tbody>';
    rows.forEach(r => {
      html += '<tr>';
      r.forEach(c => html += `<td style="border:1px solid #999;padding:3px">${c || ''}</td>`);
      html += '</tr>';
    });
    html += '</tbody></table>';

    const modal = document.createElement('div');
    modal.className = 'modal-backdrop';
    modal.innerHTML = `
      <div class="modal" style="width:80%;max-height:80%;overflow:auto;background:#fff;padding:12px;position:relative">
        <button style="position:absolute;top:5px;right:5px" class="btn" onclick="this.closest('.modal-backdrop').remove()">Đóng</button>
        <h3 style="margin-top:0">Chi tiết ${groupCol === '0' ? 'Huyện' : 'Cụm'}: ${key}</h3>
        <div style="margin-top:36px;overflow:auto">${html}</div>
      </div>`;
    document.body.appendChild(modal);
  }
});
</script>



  
  
</body>
</html>
