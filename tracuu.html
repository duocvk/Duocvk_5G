<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tra cứu trạm 5G</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f9f9f9; }
h2 { margin-bottom:10px; }
.tabs { display:flex; margin-bottom:10px; }
.tab { padding:10px 20px; cursor:pointer; background:#eee; margin-right:5px; border-radius:5px 5px 0 0; }
.tab.active { background:#4285F4; color:white; font-weight:bold; }
.tab-content { display:none; background:white; padding:15px; border-radius:0 5px 5px 5px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.tab-content.active { display:block; }
#autocomplete-list { border:1px solid #d4d4d4; max-height:150px; overflow-y:auto; position:absolute; background:white; z-index:99; width:100%; }
.autocomplete-item { padding:5px; cursor:pointer; }
.autocomplete-item:hover { background:#e9e9e9; }
#filter_div select { margin-right:10px; padding:5px; }
#total_ok { margin:10px 0; font-weight:bold; color:#333; }
/* Wrap header text */
.google-visualization-table-th div {
  white-space: normal !important;
  word-break: break-word;
  text-align:center;
}
</style>
</head>
<body>
<h2>Tra cứu trạm 5G</h2>

<div class="tabs">
  <div class="tab active" data-target="tab_chung">Tra cứu chung</div>
  <div class="tab" data-target="tab_calloff">Tra cứu Calloff</div>
  <div class="tab" data-target="tab_total">Tổng trạm đã lắp</div>
</div>

<!-- Tra cứu chung -->
<div class="tab-content active" id="tab_chung">
  <div style="position:relative; width:300px;">
    <input type="text" id="search_chung" placeholder="Nhập mã trạm, cụm hoặc huyện">
  </div>
  <div id="table_chung" style="margin-top:20px;"></div>
</div>

<!-- Tra cứu Calloff -->
<div class="tab-content" id="tab_calloff">
  <div style="position:relative; width:300px;">
    <input type="text" id="search_calloff" placeholder="Nhập mã trạm, cụm hoặc huyện">
  </div>
  <div id="table_calloff" style="margin-top:20px;"></div>
</div>

<!-- Tổng trạm -->
<div class="tab-content" id="tab_total">
  <div id="filter_div">
    <select id="filter_huyen"></select>
    <select id="filter_cum"></select>
    <select id="filter_type">
      <option value="">Tất cả trạm</option>
      <option value="lapdat">Trạm đã lắp đặt</option>
      <option value="tichhop">Trạm đã tích hợp</option>
    </select>
  </div>
  <div id="total_ok"></div>
  <div id="table_total" style="margin-top:20px;"></div>
</div>

<script>
google.charts.load('current', {'packages':['table']});
google.charts.setOnLoadCallback(initApp);

let dataChung, dataCalloff, dataTotal;
let sugChung=[], sugCalloff=[], sugTotal=[];

// --- INIT ---
function initApp(){
  initTabs();
  loadSheet('sheet', 'chung');
  loadSheet('calloff','calloff');
  loadSheet('sheet','total', true);
}

// --- TABS ---
function initTabs(){
  const tabs=document.querySelectorAll('.tab');
  tabs.forEach(tab=>{
    tab.addEventListener('click', function(){
      tabs.forEach(t=>t.classList.remove('active'));
      this.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.getElementById(this.dataset.target).classList.add('active');
    });
  });
}

// --- LOAD SHEET ---
function loadSheet(sheetName,key,isTotal=false){
  const query = new google.visualization.Query(
    `https://docs.google.com/spreadsheets/d/1Oc1rFENKMMuwG7XqqIm_MAlDi2Hkvi77m1ex5mC0N-8/gviz/tq?sheet=${sheetName}`
  );
  query.send(resp=>{
    if(resp.isError()){ alert(resp.getMessage()); return; }
    const dt = resp.getDataTable();

    // Wrap header text
    for(let c=0;c<dt.getNumberOfColumns();c++){
      const label = dt.getColumnLabel(c);
      dt.setColumnLabel(c,'<div style="white-space:normal;">'+label+'</div>');
    }

    if(key==='chung'){ dataChung=dt; sugChung=getSug(dt); drawTable(dt,'table_chung'); initAuto('search_chung',dt,sugChung,'table_chung'); }
    if(key==='calloff'){ dataCalloff=dt; sugCalloff=getSug(dt); drawTable(dt,'table_calloff'); initAuto('search_calloff',dt,sugCalloff,'table_calloff'); }
    if(key==='total'){ dataTotal=dt; sugTotal=getSug(dt); drawTable(dt,'table_total'); setupFilterTotal(dt); updateTotalCount(dt); }
  });
}

function getSug(dt){
  const s = new Set();
  for(let r=0;r<dt.getNumberOfRows();r++){
    s.add((dt.getValue(r,0)||'')+' (Mã trạm)');
    s.add((dt.getValue(r,1)||'')+' (Cụm)');
    s.add((dt.getValue(r,2)||'')+' (Huyện)');
  }
  return Array.from(s);
}

function drawTable(dt,div){ new google.visualization.Table(document.getElementById(div)).draw(dt,{showRowNumber:true,width:'100%',height:'100%',allowHtml:true,page:'enable',pageSize:20}); }

// --- AUTOCOMPLETE ---
function initAuto(inpId,dt,sug,tableDiv){
  const inp=document.getElementById(inpId);
  inp.addEventListener('input',function(){
    const val=this.value.toLowerCase();
    closeAllLists();
    if(!val) return;
    const list=document.createElement('DIV');
    list.setAttribute('id','autocomplete-list');
    this.parentNode.appendChild(list);
    let count=0;
    for(let i=0;i<sug.length&&count<10;i++){
      if(sug[i].toLowerCase().includes(val)){
        const item=document.createElement('DIV');
        item.innerHTML=sug[i];
        item.classList.add('autocomplete-item');
        item.addEventListener('click',function(){
          let valText = this.innerText.replace(/\s*\(Mã trạm\)|\s*\(Cụm\)|\s*\(Huyện\)/gi,'').toLowerCase();
          let col = 0;
          if(this.innerText.includes('(Cụm)')) col = 1;
          else if(this.innerText.includes('(Huyện)')) col = 2;

          const f = new google.visualization.DataTable();
          for(let c=0;c<dt.getNumberOfColumns();c++) f.addColumn(dt.getColumnType(c), dt.getColumnLabel(c));
          for(let r=0;r<dt.getNumberOfRows();r++){
              if((dt.getValue(r,col)||'').toString().toLowerCase().includes(valText)){
                  const row = [];
                  for(let c=0;c<dt.getNumberOfColumns();c++) row.push(dt.getValue(r,c));
                  f.addRow(row);
              }
          }
          drawTable(f,tableDiv);
          if(tableDiv==='table_total') updateTotalCount(f);

          // XÓA INPUT SAU KHI CHỌN
          inp.value='';
        });
        list.appendChild(item); count++;
      }
    }
  });
  function closeAllLists(){ const x=document.getElementsByClassName('autocomplete-item'); for(let i=x.length-1;i>=0;i--) x[i].parentNode.remove(); }
  document.addEventListener('click',e=>closeAllLists());
}

// --- TOTAL TAB ---
function setupFilterTotal(dt){
  const hSet=new Set(), cSet=new Set();
  for(let r=0;r<dt.getNumberOfRows();r++){ const h=dt.getValue(r,2)||''; const c=dt.getValue(r,1)||''; if(h) hSet.add(h); if(c) cSet.add(c);}
  const hS=document.getElementById('filter_huyen'), cS=document.getElementById('filter_cum'), tS=document.getElementById('filter_type');
  hS.innerHTML="<option value=''>Tất cả huyện</option>"; cS.innerHTML="<option value=''>Tất cả cụm</option>";
  hSet.forEach(h=>{const o=document.createElement('option'); o.value=h; o.text=h; hS.appendChild(o);});
  cSet.forEach(c=>{const o=document.createElement('option'); o.value=c; o.text=c; cS.appendChild(o);});
  hS.onchange=filterTotal; cS.onchange=filterTotal; tS.onchange=filterTotal;
}

function filterTotal(){
  const h=document.getElementById('filter_huyen').value.toLowerCase();
  const c=document.getElementById('filter_cum').value.toLowerCase();
  const type=document.getElementById('filter_type').value;
  const dt=dataTotal; if(!dt) return;

  const f=new google.visualization.DataTable();
  for(let col=0;col<dt.getNumberOfColumns();col++) f.addColumn(dt.getColumnType(col), dt.getColumnLabel(col));

  for(let r=0;r<dt.getNumberOfRows();r++){
    const rowH=(dt.getValue(r,2)||'').toLowerCase();
    const rowC=(dt.getValue(r,1)||'').toLowerCase();

    if((!h || rowH===h) && (!c || rowC===c)){
      if(type==='lapdat' && dt.getValue(r,5)!=1) continue;
      if(type==='tichhop' && dt.getValue(r,6)!=1) continue;

      const row=[]; for(let col=0;col<dt.getNumberOfColumns();col++) row.push(dt.getValue(r,col));
      f.addRow(row);
    }
  }
  drawTable(f,'table_total');
  updateTotalCount(f);
}

function updateTotalCount(dt){
  let countLapDat = 0, countTichHop = 0;
  const colLapDat = 5; // F
  const colTichHop = 6; // G
  for(let r=0;r<dt.getNumberOfRows();r++){
    if(dt.getValue(r,colLapDat)==1) countLapDat++;
    if(dt.getValue(r,colTichHop)==1) countTichHop++;
  }
  document.getElementById('total_ok').innerText =
    "Trạm đã lắp đặt: "+countLapDat+" | Trạm đã tích hợp: "+countTichHop;
}
</script>
</body>
</html>
