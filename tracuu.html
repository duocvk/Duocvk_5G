<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Tra cứu trạm 5G</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
  :root{--blue:#0078d7;--mapLink:#1a73e8;--green:#d1eaff;--yellow:#fff6a3}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f5f7fb;color:#222}
  header{background:var(--blue);color:#fff;padding:12px 18px;text-align:center;font-weight:700}
  .wrap{max-width:1200px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  nav button{padding:8px 14px;border-radius:6px;border:1px solid #e6e9ef;background:#fff;cursor:pointer}
  nav button.active{background:var(--blue);color:#fff;border-color:var(--blue)}
  input[type=text],select{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
  #suggestions,#suggestionsCalloff{position:absolute;background:#fff;border:1px solid #ddd;border-radius:6px;max-height:220px;overflow:auto;z-index:999;width:320px}
  #suggestions div,#suggestionsCalloff div{padding:8px;cursor:pointer}
  #suggestions div:hover,#suggestionsCalloff div:hover{background:#eef8ff}
  tr.row-installed{background:var(--yellow)!important}
  tr.row-integrated{background:var(--green)!important}
  .small-btn{padding:6px 10px;border-radius:6px;background:#2f80ed;color:#fff;border:none;cursor:pointer}
  .ghost{background:#fff;color:var(--blue);border:1px solid #cfd8e3}
  .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000}
  .modal{background:#fff;padding:18px;border-radius:8px;min-width:320px;box-shadow:0 8px 30px rgba(0,0,0,0.25)}
  .modal input{width:100%;margin:6px 0;padding:8px;border:1px solid #ccc;border-radius:6px}
  .modal button{margin-top:8px;padding:8px 12px;border-radius:6px;background:var(--blue);color:#fff;border:none}
</style>
</head>
<body>
<header>TRA CỨU TRẠM 5G</header>

<div class="wrap">
  <div id="appArea" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <nav>
        <button id="btnChung" class="active" onclick="showTab('chung', this)">Tra cứu chung</button>
        <button id="btnCalloff" onclick="showTab('calloff', this)">Tra cứu Calloff</button>
        <button id="btnTong" onclick="showTab('tong', this)">Tổng hợp</button>
      </nav>
      <div><button class="ghost" onclick="logout()">Đăng xuất</button></div>
    </div>

    <div id="tab-chung">
      <h3>Tra cứu chung</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;position:relative">
        <input id="inputChung" type="text" placeholder="Tìm mã trạm, cụm, huyện..." style="width:320px" />
        <div id="suggestions"></div>
        <select id="drop_huyen_chung"><option value="">--Huyện--</option></select>
        <select id="drop_cum_chung"><option value="">--Cụm--</option></select>
        <select id="drop_tram_chung"><option value="">--Trạm--</option></select>
        <button class="small-btn" onclick="resetChung()">Reset</button>
      </div>
      <div id="table_chung" style="margin-top:12px"></div>
    </div>

    <div id="tab-calloff" style="display:none">
      <h3>Tra cứu Calloff</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;position:relative">
        <select id="drop_tram_calloff"><option value="">--Trạm (A)--</option></select>
        <select id="drop_huyen_calloff"><option value="">--Huyện (Q)--</option></select>
        <input id="inputCalloff" type="text" placeholder="Tìm trạm trong Calloff..." style="width:320px" />
        <div id="suggestionsCalloff"></div>
        <button class="small-btn" onclick="resetCalloff()">Reset</button>
      </div>
      <div id="table_calloff" style="margin-top:12px"></div>
    </div>

    <div id="tab-tong" style="display:none">
      <h3>Tổng hợp</h3>
      <div id="summaryArea"></div>
    </div>
  </div>
</div>

<div id="loginModal" class="modal-backdrop" style="display:none">
  <div class="modal">
    <h3>Đăng nhập</h3>
    <input id="login_user" type="text" placeholder="Tên đăng nhập" />
    <input id="login_pass" type="password" placeholder="Mật khẩu" />
    <button onclick="loginSubmit()">Đăng nhập</button>
    <p id="loginError" style="color:#c0392b"></p>
  </div>
</div>

<script>
google.charts.load('current', {'packages':['table']});
const SHEET_ID = '1Oc1rFENKMMuwG7XqqIm_MAlDi2Hkvi77m1ex5mC0N-8';
const URL_SHEET = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=sheet&headers=1`;
const URL_CALLOFF = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=calloff&headers=1`;

let sheetDT=null, calloffDT=null;

window.onload = ()=>{
  if(localStorage.getItem('tc_logged')==='1'){
    $('#appArea').show();
    google.charts.setOnLoadCallback(initApp);
  }else $('#loginModal').show();
};

function loginSubmit(){
  const u=$('#login_user').val(), p=$('#login_pass').val();
  if(u==='admin'&&p==='123456'){
    localStorage.setItem('tc_logged','1');
    $('#loginModal').hide(); $('#appArea').show();
    google.charts.setOnLoadCallback(initApp);
  }else $('#loginError').text('Sai tên đăng nhập hoặc mật khẩu');
}
function logout(){localStorage.removeItem('tc_logged');location.reload();}

function initApp(){
  loadSheet(URL_SHEET, dt=>{
    sheetDT=dt; renderChung(dt);
  });
  loadSheet(URL_CALLOFF, dt=>{
    calloffDT=dt; renderCalloff(dt);
  });
}

function loadSheet(url,cb){
  const q=new google.visualization.Query(url);
  q.send(r=>{
    if(r.isError()){alert('Lỗi tải dữ liệu');return;}
    cb(r.getDataTable());
  });
}

function renderChung(dt){
  populateDropdown(dt,0,'#drop_huyen_chung');
  populateDropdown(dt,1,'#drop_cum_chung');
  populateDropdown(dt,2,'#drop_tram_chung');
  drawTable(dt,'table_chung');
}
function renderCalloff(dt){
  populateDropdown(dt,0,'#drop_tram_calloff');
  populateDropdown(dt,16,'#drop_huyen_calloff');
  drawTable(dt,'table_calloff');
}
function populateDropdown(dt,col,sel){
  const s=new Set();
  for(let i=0;i<dt.getNumberOfRows();i++){
    const v=dt.getValue(i,col); if(v) s.add(v);
  }
  const el=$(sel); el.empty().append('<option value="">--Chọn--</option>');
  Array.from(s).sort().forEach(v=>el.append(`<option>${v}</option>`));
}
function drawTable(dt,container){
  const t=new google.visualization.Table(document.getElementById(container));
  t.draw(dt,{showRowNumber:true,width:'100%',page:'enable',pageSize:20});
}
function resetChung(){if(sheetDT)drawTable(sheetDT,'table_chung');}
function resetCalloff(){if(calloffDT)drawTable(calloffDT,'table_calloff');}
function showTab(tab,btn){
  $('nav button').removeClass('active');$(btn).addClass('active');
  $('#tab-chung,#tab-calloff,#tab-tong').hide();
  $(`#tab-${tab}`).show();
}
</script>
</body>
</html>
