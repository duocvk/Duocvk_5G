<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Tra cứu trạm 5G - Full</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- Google Charts và jQuery -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
  :root{--blue:#0078d7;--accent:#d1eaff;--accent2:#fff6a3}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f6f8fb;color:#222}
  header{background:var(--blue);color:#fff;padding:12px 18px;font-size:20px;font-weight:600}
  .container{padding:16px}
  .card{background:#fff;border-radius:8px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.08);max-width:1000px;margin:10px auto;}
  .row{display:flex;gap:12px;align-items:center;margin-bottom:10px}
  input[type=text],input[type=password],select{padding:8px;border:1px solid #ccc;border-radius:6px;font-size:14px}
  button{background:var(--blue);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
  button.ghost{background:#fff;color:var(--blue);border:1px solid #cfd8e3}
  nav{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  nav button{padding:8px 14px;border-radius:6px;border:1px solid #e0e6ef;background:#fff;cursor:pointer}
  nav button.active{background:var(--blue);color:#fff;border-color:var(--blue)}
  .tab{background:#fff;padding:12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.04)}
  #suggestions,#suggestionsCalloff{position:absolute;background:#fff;border:1px solid #ddd;border-radius:6px;max-height:220px;overflow:auto;z-index:999;width:320px}
  #suggestions div,#suggestionsCalloff div{padding:8px;cursor:pointer}
  #suggestions div:hover,#suggestionsCalloff div:hover{background:#f0f8ff}
  table.google-visualization-table-table{border-collapse:collapse !important;width:100% !important}
  .google-visualization-table-table td,.google-visualization-table-table th{border:1px solid #ddd !important;padding:6px !important}
  .row-highlight{outline:3px solid rgba(0,120,215,0.15)}
  tr.daLap{background:var(--accent2) !important}
  tr.daTichHop{background:var(--accent) !important}
  .small-btn{padding:6px 10px;border-radius:6px;background:#2f80ed;color:#fff;border:none;cursor:pointer}
  @media(max-width:900px){ input[type=text],select{width:100%} #suggestions,#suggestionsCalloff{width:90vw} }
</style>
</head>
<body>
<header>TRA CỨU TRẠM 5G</header>

<!-- LOGIN -->
<div id="login-screen" class="card" style="max-width:420px;margin-top:30px;">
  <h3 style="margin-top:0">Đăng nhập</h3>
  <div class="row" style="flex-direction:column">
    <input id="user" type="text" placeholder="Tên đăng nhập" />
    <input id="pass" type="password" placeholder="Mật khẩu" />
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;width:100%">
      <button onclick="login()">Đăng nhập</button>
    </div>
    <p id="login-msg" style="color:#d63636"></p>
    <p style="font-size:12px;color:#666">Mặc định: <strong>admin</strong> / <strong>123456</strong></p>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <div class="container card" style="max-width:1200px;">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <nav>
        <button id="tabBtnChung" class="active" onclick="showTab('chung', this)">Tra cứu chung</button>
        <button id="tabBtnCalloff" onclick="showTab('calloff', this)">Tra cứu Calloff</button>
        <button id="tabBtnTong" onclick="showTab('tong', this)">Tổng hợp</button>
      </nav>
      <div>
        <button class="ghost" onclick="logout()">Đăng xuất</button>
      </div>
    </div>

    <!-- Tra cứu chung -->
    <div id="tab-chung" class="tab" style="margin-top:12px">
      <h3>Tra cứu chung</h3>
      <div class="row" style="position:relative;flex-wrap:wrap">
        <input id="searchChung" type="text" placeholder="Tìm mã trạm / cụm / huyện (gõ 206 hoặc 'Tam')" style="width:320px" />
        <div id="suggestions"></div>

        <!-- dropdowns nhanh -->
        <select id="drop_tram_chung" title="Chọn trạm (cột C)"><option value="">--Chọn trạm (C)--</option></select>
        <select id="drop_huyen_chung" title="Chọn huyện (cột A)"><option value="">--Chọn huyện (A)--</option></select>
        <select id="drop_cum_chung" title="Chọn cụm (cột B)"><option value="">--Chọn cụm (B)--</option></select>
        <button class="small-btn" onclick="resetChung()">Reset</button>
      </div>
      <div id="table_chung" style="margin-top:12px"></div>
    </div>

    <!-- Calloff -->
    <div id="tab-calloff" class="tab" style="display:none;margin-top:12px">
      <h3>Tra cứu Calloff</h3>
      <div class="row" style="flex-wrap:wrap;position:relative">
        <select id="drop_tram_calloff"><option value="">--Chọn trạm (A)--</option></select>
        <select id="drop_huyen_calloff"><option value="">--Chọn huyện (Q)--</option></select>
        <input id="searchCalloff" type="text" placeholder="Tìm trạm trong Calloff..." style="width:320px" />
        <div id="suggestionsCalloff"></div>
        <button class="small-btn" onclick="resetCalloff()">Reset</button>
      </div>
      <div id="table_calloff" style="margin-top:12px"></div>
    </div>

    <!-- Tổng hợp -->
    <div id="tab-tong" class="tab" style="display:none;margin-top:12px">
      <h3>Tổng hợp</h3>
      <div class="row" style="flex-wrap:wrap">
        <button class="small-btn" onclick="renderSummary('huyen')">Theo Huyện</button>
        <button class="small-btn" onclick="renderSummary('cum')">Theo Cụm</button>
        <select id="summary-filter" style="margin-left:8px">
          <option value="">Tất cả</option>
          <option value="lapdat">Chỉ trạm đã lắp</option>
          <option value="tichhop">Chỉ trạm đã tích hợp</option>
        </select>
      </div>
      <div id="summary-area" style="margin-top:12px"></div>
      <div id="summary-detail" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
/* ===============================
   Config / URLs / Globals
   =============================== */
google.charts.load('current', {'packages':['table']});
const SHEET_ID = '1Oc1rFENKMMuwG7XqqIm_MAlDi2Hkvi77m1ex5mC0N-8';
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=sheet&headers=1`;
const CALLOFF_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=calloff&headers=1`;

let sheetDT = null;      // DataTable for sheet
let calloffDT = null;    // DataTable for calloff
let metaSheet = {};      // columns indices for sheet
let metaCalloff = {};    // columns indices for calloff

/* ===============================
   Auth UI
   =============================== */
function login(){
  const u = document.getElementById('user').value;
  const p = document.getElementById('pass').value;
  if(u==='admin' && p==='123456'){
    localStorage.setItem('loggedIn','1');
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').style.display='block';
    google.charts.setOnLoadCallback(initApp);
  } else {
    document.getElementById('login-msg').innerText='Sai user hoặc mật khẩu';
  }
}
function logout(){ localStorage.removeItem('loggedIn'); location.reload(); }
if(localStorage.getItem('loggedIn')){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  google.charts.setOnLoadCallback(initApp);
}

/* ===============================
   Init App: load both sheets
   =============================== */
function initApp(){
  loadSheet(SHEET_URL, 'sheet', onLoadSheet);
  loadSheet(CALLOFF_URL, 'calloff', onLoadCalloff);
  setupUIBindings();
}

function loadSheet(url, kind, cb){
  const q = new google.visualization.Query(url);
  q.send(resp=>{
    if(resp.isError()){
      alert('Lỗi tải dữ liệu: ' + resp.getMessage());
      return;
    }
    cb(resp);
  });
}

/* ===============================
   After load: build meta and initial draws
   =============================== */

function onLoadSheet(resp){
  sheetDT = resp.getDataTable();
  // fixed positions per agreement:
  // A=0 (huyen), B=1 (cum), C=2 (tram), F=5 (lap), G=6 (tichhop)
  const ncol = sheetDT.getNumberOfColumns();
  const latCol = Math.max(0, ncol-2);
  const lngCol = Math.max(0, ncol-1);
  metaSheet = {
    tramCol: 2,
    huyenCol: 0,
    cumCol: 1,
    lapCol: 5,
    tichhopCol: 6,
    latCol: latCol,
    lngCol: lngCol
  };
  // populate dropdowns (chung)
  populateDropdownFromColumn(sheetDT, metaSheet.tramCol, '#drop_tram_chung', true);
  populateDropdownFromColumn(sheetDT, metaSheet.huyenCol, '#drop_huyen_chung', true);
  populateDropdownFromColumn(sheetDT, metaSheet.cumCol, '#drop_cum_chung', true);

  // initial view hide lat/lng
  const view = hideLatLng(sheetDT, metaSheet.latCol, metaSheet.lngCol);
  drawTable(view, 'table_chung', sheetDT, metaSheet);
}

function onLoadCalloff(resp){
  calloffDT = resp.getDataTable();
  const ncol = calloffDT.getNumberOfColumns();
  // cột mã trạm A=0, huyện Q = index 16 (Q) per your info
  const tramCol = 0;
  const huyenQ = 16; // user says Q
  const latCol = Math.max(0, ncol-2);
  const lngCol = Math.max(0, ncol-1);
  metaCalloff = {
    tramCol: tramCol,
    huyenColQ: huyenQ,
    latCol: latCol,
    lngCol: lngCol,
    lapCol: 5,
    tichhopCol: 6
  };
  // populate calloff dropdowns: trạm from col A, huyện from col Q
  populateDropdownFromColumn(calloffDT, metaCalloff.tramCol, '#drop_tram_calloff', true);
  // For col Q may have empty or not, build list defensively
  populateDropdownFromColumn(calloffDT, metaCalloff.huyenColQ, '#drop_huyen_calloff', true);

  const view = hideLatLng(calloffDT, metaCalloff.latCol, metaCalloff.lngCol);
  drawTable(view, 'table_calloff', calloffDT, metaCalloff);
}

/* ===============================
   UI Bindings (search, dropdowns)
   =============================== */
function setupUIBindings(){
  // CHUNG: autocomplete input
  $('#searchChung').on('input', function(){
    const v = $(this).val().trim();
    $('#suggestions').empty();
    if(!v || !sheetDT) return;
    const suggestions = buildSuggestionsFromDT(sheetDT, [metaSheet.tramCol, metaSheet.cumCol, metaSheet.huyenCol], v);
    suggestions.slice(0,20).forEach(s=>{
      $('<div>').text(s).appendTo('#suggestions').on('click', function(){
        $('#searchChung').val('');
        $('#suggestions').empty();
        filterByKeywordAndDraw(sheetDT, s, 'table_chung', metaSheet);
      });
    });
  });
  // CHUNG dropdowns
  $('#drop_tram_chung').on('change', function(){ const v=this.value; if(!v) resetChung(); else filterByKeywordAndDraw(sheetDT, v, 'table_chung', metaSheet); });
  $('#drop_huyen_chung').on('change', function(){ const v=this.value; if(!v) resetChung(); else filterByKeywordAndDraw(sheetDT, v, 'table_chung', metaSheet); });
  $('#drop_cum_chung').on('change', function(){ const v=this.value; if(!v) resetChung(); else filterByKeywordAndDraw(sheetDT, v, 'table_chung', metaSheet); });

  // CALLOFF autocomplete & dropdowns
  $('#searchCalloff').on('input', function(){
    const v = $(this).val().trim();
    $('#suggestionsCalloff').empty();
    if(!v || !calloffDT) return;
    const suggestions = buildSuggestionsFromDT(calloffDT, [metaCalloff.tramCol, metaCalloff.huyenColQ], v);
    suggestions.slice(0,20).forEach(s=>{
      $('<div>').text(s).appendTo('#suggestionsCalloff').on('click', function(){
        $('#searchCalloff').val('');
        $('#suggestionsCalloff').empty();
        filterByKeywordAndDraw(calloffDT, s, 'table_calloff', metaCalloff);
      });
    });
  });
  $('#drop_tram_calloff').on('change', function(){ const v=this.value; if(!v) resetCalloff(); else filterByKeywordAndDraw(calloffDT, v, 'table_calloff', metaCalloff); });
  $('#drop_huyen_calloff').on('change', function(){ const v=this.value; if(!v) resetCalloff(); else filterByKeywordAndDraw(calloffDT, v, 'table_calloff', metaCalloff); });

  // Summary filter change
  $('#summary-filter').on('change', function(){
    // re-render current summary if exists
    const curMode = $('#summary-area').data('mode') || null;
    if(curMode) renderSummary(curMode);
  });
}

/* ===============================
   Helpers: populate dropdowns, suggestions
   =============================== */
function populateDropdownFromColumn(dt, colIndex, selector, includeBlank){
  const set = new Set();
  if(colIndex < 0) return;
  for(let r=0;r<dt.getNumberOfRows();r++){
    const v = dt.getValue(r, colIndex);
    if(v !== null && v !== undefined && v.toString().trim() !== '') set.add(v.toString());
  }
  const arr = Array.from(set).sort();
  const el = document.querySelector(selector);
  if(!el) return;
  if(includeBlank){
    el.innerHTML = '<option value="">--Chọn--</option>';
  } else {
    el.innerHTML = '';
  }
  arr.forEach(v=>{
    const opt = document.createElement('option'); opt.value = v; opt.textContent = v; el.appendChild(opt);
  });
}

function buildSuggestionsFromDT(dt, cols, query){
  const q = query.toLowerCase();
  const s = new Set();
  for(let r=0;r<dt.getNumberOfRows();r++){
    for(const c of cols){
      if(c < 0 || c >= dt.getNumberOfColumns()) continue;
      const v = dt.getValue(r,c);
      if(v && v.toString().toLowerCase().includes(q)) s.add(v.toString());
    }
  }
  return Array.from(s);
}

/* ===============================
   Filter & draw
   =============================== */
function filterByKeywordAndDraw(dtSource, keyword, containerId, meta){
  if(!dtSource) return;
  const rows = [];
  const N = dtSource.getNumberOfRows();
  const M = dtSource.getNumberOfColumns();
  for(let r=0;r<N;r++){
    let ok = false;
    for(let c=0;c<M;c++){
      const v = dtSource.getValue(r,c);
      if(v && v.toString().toLowerCase().includes(keyword.toLowerCase())){ ok = true; break; }
    }
    if(ok) rows.push(r);
  }
  const view = new google.visualization.DataView(dtSource);
  view.setRows(rows);
  // hide lat/lng in view
  const viewHidden = hideLatLngFromView(view, meta ? meta.latCol : dtSource.getNumberOfColumns()-2, meta ? meta.lngCol : dtSource.getNumberOfColumns()-1);
  drawTable(viewHidden, containerId, dtSource, meta);
}

function resetChung(){
  if(!sheetDT) return;
  const view = hideLatLng(sheetDT, metaSheet.latCol, metaSheet.lngCol);
  drawTable(view, 'table_chung', sheetDT, metaSheet);
  $('#drop_tram_chung').val('');
  $('#drop_huyen_chung').val('');
  $('#drop_cum_chung').val('');
  $('#searchChung').val('');
  $('#suggestions').empty();
}
function resetCalloff(){
  if(!calloffDT) return;
  const view = hideLatLng(calloffDT, metaCalloff.latCol, metaCalloff.lngCol);
  drawTable(view, 'table_calloff', calloffDT, metaCalloff);
  $('#drop_tram_calloff').val('');
  $('#drop_huyen_calloff').val('');
  $('#searchCalloff').val('');
  $('#suggestionsCalloff').empty();
}

/* ===============================
   Hide lat/lng: build DataView excluding lat/lng columns
   =============================== */
function hideLatLng(dt, latCol, lngCol){
  const view = new google.visualization.DataView(dt);
  const cols = [];
  for(let c=0;c<dt.getNumberOfColumns();c++){
    if(c === latCol || c === lngCol) continue;
    cols.push(c);
  }
  view.setColumns(cols);
  return view;
}
// if view is already a DataView, build another DataView excluding columns using source column indices
function hideLatLngFromView(viewObj, latCol, lngCol){
  // viewObj may be DataView built on source. But easiest: get source table from viewObj.getTable? Not guaranteed.
  // Simpler: if viewObj has getNumberOfColumns etc, we need to build a DataTable from view then remove last two numeric columns if look like lat/lng.
  // We'll attempt to construct new DataView that excludes columns whose labels look like lat/lng (best effort)
  try{
    // try to derive source columns from viewObj
    const cols = [];
    for(let c=0;c<viewObj.getNumberOfColumns();c++){
      cols.push(c);
    }
    // attempt to detect numeric last two columns by sampling first row
    const ncol = viewObj.getNumberOfColumns();
    if(ncol >= 2){
      const last = viewObj.getValue(0, ncol-1);
      const second = viewObj.getValue(0, ncol-2);
      const isNumLast = last !== null && !isNaN(parseFloat(last));
      const isNumSecond = second !== null && !isNaN(parseFloat(second));
      if(isNumLast && isNumSecond){
        cols.pop(); cols.pop();
      }
    }
    const v2 = new google.visualization.DataView(viewObj);
    v2.setColumns(cols);
    return v2;
  } catch(e){
    // fallback: return original view
    return viewObj;
  }
}

/* ===============================
   Draw table and post-process (color rows, add map link, hide lat/lng)
   dtView = DataView or DataTable to pass to draw
   dtSource = original DataTable (used for lat/lng, tram name if needed)
   meta = mapping object {tramCol,huyenCol,cumCol,lapCol,tichhopCol,latCol,lngCol}
   =============================== */
function drawTable(dtView, containerId, dtSource, meta){
  const table = new google.visualization.Table(document.getElementById(containerId));
  google.visualization.events.addListener(table,'ready', function(){
    // post-process rows
    const tbl = document.querySelector('#'+containerId+' table');
    if(!tbl) return;
    const tbody = tbl.querySelector('tbody');
    if(!tbody) return;
    const rows = tbody.querySelectorAll('tr');
    // Since dtView has columns same as source except lat/lng removed (we built that way),
    // indices for F and G remain 5 and 6 (0-based) as long as lat/lng are last two.
    rows.forEach((tr, idx) => {
      const cells = tr.querySelectorAll('td');
      // defensive: ensure at least 7 columns exist to check F(5) and G(6)
      if(cells.length >= 7){
        const valF = cells[5].innerText.trim();
        const valG = cells[6].innerText.trim();
        const isLap = (valF === '1' || valF === 1);
        const isTich = (valG === '1' || valG === 1);
        if(isLap && isTich){
          tr.classList.add('daTichHop');
        } else if(isLap && !isTich){
          tr.classList.add('daLap');
        } else {
          // no color
        }
      }
      // create map link in last visible cell
      if(cells.length >= 3){
        // attempt to find lat/lng from dtSource using mapping: need original row index
        // The index idx corresponds to view row; get underlying source row via dtView.getTableRowIndex? Not available
        // But if dtView is a DataView built from dtSource with setRows(rows) or hideLatLng, its row indices align: use dtView.getValue
      }
    });

    // hide last two columns if they accidentally visible (extra safety)
    // We'll hide columns whose text looks numeric coordinates
    rows.forEach(tr=>{
      const cells = tr.querySelectorAll('td');
      if(cells.length>=2){
        const last = cells[cells.length-1];
        const secondLast = cells[cells.length-2];
        if(last && /^-?\d+(\.\d+)?$/.test(last.innerText.trim())) last.style.display='none';
        if(secondLast && /^-?\d+(\.\d+)?$/.test(secondLast.innerText.trim())) secondLast.style.display='none';
      }
    });
  });

  table.draw(dtView, {showRowNumber:true, allowHtml:true, width:'100%', page:'enable', pageSize:20});
}

/* ===============================
   Summary (group by huyen or cum)
   =============================== */
function renderSummary(mode){
  if(!sheetDT) return;
  const dt = sheetDT;
  const groupCol = (mode==='huyen') ? metaSheet.huyenCol : metaSheet.cumCol;
  const sum = new Map();
  for(let r=0;r<dt.getNumberOfRows();r++){
    const key = (dt.getValue(r, groupCol) || '(Không xác định)').toString();
    if(!sum.has(key)) sum.set(key, {total:0, lap:0, tich:0, rows:[]});
    const obj = sum.get(key);
    obj.total++;
    const lap = dt.getValue(r, metaSheet.lapCol);
    const tich = dt.getValue(r, metaSheet.tichhopCol);
    if(lap==1 || lap==='1') obj.lap++;
    if(tich==1 || tich==='1') obj.tich++;
    obj.rows.push(r);
  }

  // generate HTML table
  let html = `<table border="1" cellpadding="6" style="width:100%;border-collapse:collapse"><thead style="background:#f0f4ff"><tr><th>STT</th><th>${mode==='huyen'?'Huyện':'Cụm'}</th><th>Tổng</th><th>Đã lắp</th><th>Đã tích hợp</th><th>% lắp</th><th>% tích hợp</th><th></th></tr></thead><tbody>`;
  let i = 0;
  Array.from(sum.entries()).sort((a,b)=>b[1].total - a[1].total).forEach(([key,val])=>{
    i++;
    const pctLap = val.total ? Math.round(val.lap*100/val.total) : 0;
    const pctTich = val.total ? Math.round(val.tich*100/val.total) : 0;
    html += `<tr>
      <td style="text-align:center">${i}</td>
      <td>${escapeHtml(key)}</td>
      <td style="text-align:center">${val.total}</td>
      <td style="text-align:center">${val.lap}</td>
      <td style="text-align:center">${val.tich}</td>
      <td style="text-align:center">${pctLap}%</td>
      <td style="text-align:center">${pctTich}%</td>
      <td style="text-align:center"><button class="small-btn" onclick="showDetail('${escapeQuotes(key)}','${mode}')">Xem chi tiết</button></td>
    </tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById('summary-area').innerHTML = html;
  document.getElementById('summary-area').dataset.mode = mode;
  document.getElementById('summary-detail').innerHTML = '';
}

/* ===============================
   Show detail (list trạm of a group)
   =============================== */
function showDetail(key, mode){
  if(!sheetDT) return;
  const dt = sheetDT;
  const groupCol = (mode==='huyen') ? metaSheet.huyenCol : metaSheet.cumCol;
  // gather rows
  const rows = [];
  for(let r=0;r<dt.getNumberOfRows();r++){
    const v = (dt.getValue(r, groupCol) || '').toString();
    if(v === key) rows.push(r);
  }
  if(rows.length===0){
    document.getElementById('summary-detail').innerHTML = '<p>Không có dữ liệu chi tiết</p>';
    return;
  }
  // build DataTable of these rows
  const f = new google.visualization.DataTable();
  for(let c=0;c<dt.getNumberOfColumns();c++) f.addColumn(dt.getColumnType(c), dt.getColumnLabel(c));
  rows.forEach(r=>{
    const row = [];
    for(let c=0;c<dt.getNumberOfColumns();c++) row.push(dt.getValue(r,c));
    f.addRow(row);
  });
  const view = hideLatLng(f, f.getNumberOfColumns()-2, f.getNumberOfColumns()-1);
  document.getElementById('summary-detail').innerHTML = `<h4>Chi tiết ${mode}: ${escapeHtml(key)}</h4><div id="detail_table"></div>`;
  drawTable(view, 'detail_table', f, metaSheet);
}

/* ===============================
   Utils
   =============================== */
function escapeHtml(s){ return (s+'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function escapeQuotes(s){ return (s+'').replace(/'/g,"\\'").replace(/"/g,"&quot;"); }

</script>
</body>
</html>
