<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tra cứu 5G</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f6fa;
  margin: 0;
}
header {
  background: #0078d7;
  color: white;
  padding: 12px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
}
nav {
  background: #eaeaea;
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 10px;
}
nav button {
  background: white;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 6px 14px;
  cursor: pointer;
  font-weight: bold;
}
nav button.active {
  background: #0078d7;
  color: white;
  border-color: #0078d7;
}
.container { padding: 20px; }
input[type="text"] {
  width: 300px; padding: 6px; border-radius: 6px; border: 1px solid #ccc;
}
#suggestions, #suggestionsCalloff {
  position: absolute; background: white; border: 1px solid #ccc;
  border-radius: 6px; max-height: 200px; overflow-y: auto;
  width: 300px; z-index: 999;
}
#suggestions div, #suggestionsCalloff div {
  padding: 5px 10px; cursor: pointer;
}
#suggestions div:hover, #suggestionsCalloff div:hover {
  background: #d1eaff;
}
.google-visualization-table-table {
  border-collapse: collapse !important; width: 100% !important;
}
.google-visualization-table-table td, 
.google-visualization-table-table th {
  border: 1px solid #ddd !important; padding: 5px !important;
}
tr.highlighted { outline: 2px solid #0078d7; }
#login {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; height: 80vh;
}
#login input {
  margin: 6px; padding: 8px; border: 1px solid #ccc;
  border-radius: 6px;
}
#logout {
  position: absolute; right: 10px; top: 10px;
  background: #ff6b6b; border: none; color: white;
  padding: 6px 10px; border-radius: 6px; cursor: pointer;
}
</style>
</head>

<body>
<header>HỆ THỐNG TRA CỨU 5G</header>
<div id="login">
  <h2>Đăng nhập</h2>
  <input type="text" id="username" placeholder="Tên đăng nhập">
  <input type="password" id="password" placeholder="Mật khẩu">
  <button onclick="login()">Đăng nhập</button>
  <p id="login-msg" style="color:red;"></p>
</div>

<div id="main" style="display:none;">
  <button id="logout" onclick="logout()">Đăng xuất</button>
  <nav>
    <button class="active" onclick="showTab('chung', this)">Tra cứu chung</button>
    <button onclick="showTab('calloff', this)">Tra cứu Calloff</button>
    <button onclick="showTab('tong', this)">Tổng hợp</button>
  </nav>

  <div class="container">
    <div id="tab-chung" class="tab">
      <h3>Tra cứu chung</h3>
      <input type="text" id="searchBox" placeholder="Nhập mã trạm, cụm, huyện...">
      <div id="suggestions"></div>
      <div id="table_div"></div>
    </div>

    <div id="tab-calloff" class="tab" style="display:none;">
      <h3>Tra cứu Calloff</h3>
      <input type="text" id="searchCalloff" placeholder="Nhập mã trạm...">
      <div id="suggestionsCalloff"></div>
      <div id="table_calloff"></div>
    </div>

    <div id="tab-tong" class="tab" style="display:none;">
      <h3>Tổng hợp theo Huyện hoặc Cụm</h3>
      <button onclick="buildSummary('Huyện')">Theo Huyện</button>
      <button onclick="buildSummary('Cụm')">Theo Cụm</button>
      <div id="tong_div"></div>
    </div>
  </div>
</div>

<script>
google.charts.load('current', {'packages':['table']});
const sheetURL = 'https://docs.google.com/spreadsheets/d/1Oc1rFENKMMuwG7XqqIm_MAlDi2Hkvi77m1ex5mC0N-8/gviz/tq?sheet=sheet';
const calloffURL = 'https://docs.google.com/spreadsheets/d/1Oc1rFENKMMuwG7XqqIm_MAlDi2Hkvi77m1ex5mC0N-8/gviz/tq?sheet=calloff';
let sheetData = null;

function login(){
  const u=document.getElementById('username').value;
  const p=document.getElementById('password').value;
  if(u==='admin'&&p==='123456'){
    localStorage.setItem('loggedIn','true');
    document.getElementById('login').style.display='none';
    document.getElementById('main').style.display='block';
  }else document.getElementById('login-msg').innerText='Sai tài khoản hoặc mật khẩu!';
}
function logout(){ localStorage.removeItem('loggedIn'); location.reload(); }
if(localStorage.getItem('loggedIn')){
  document.getElementById('login').style.display='none';
  document.getElementById('main').style.display='block';
}

function showTab(tab, btn){
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.getElementById('tab-'+tab).style.display='block';
}

google.charts.setOnLoadCallback(initData);
function initData(){
  querySheet(sheetURL, function(dt){
    sheetData = dt;
    buildSuggestions(dt, '#searchBox', '#suggestions', 'table_div');
    drawTable(dt, 'table_div');
  });
  querySheet(calloffURL, function(dt){
    buildSuggestions(dt, '#searchCalloff', '#suggestionsCalloff', 'table_calloff');
    drawTable(dt, 'table_calloff');
  });
}

function querySheet(url, cb){
  const q=new google.visualization.Query(url);
  q.send(r=>{ if(r.isError()) alert('Lỗi tải dữ liệu'); else cb(r); });
}

function buildSuggestions(dt, inputSel, sugSel, tableId){
  const data = [];
  for(let i=0;i<dt.getDataTable().getNumberOfRows();i++){
    for(let j=0;j<dt.getDataTable().getNumberOfColumns();j++){
      const val = dt.getDataTable().getValue(i,j);
      if(val) data.push(val.toString());
    }
  }
  $(inputSel).on('input',function(){
    const val=$(this).val().toLowerCase();
    const sug=$(sugSel); sug.empty();
    if(!val) return;
    const matches=[...new Set(data.filter(v=>v.toLowerCase().includes(val)))];
    matches.slice(0,10).forEach(item=>{
      $('<div>').text(item).appendTo(sug).click(()=>{
        $(inputSel).val(''); sug.empty(); filterData(item, tableId, dt);
      });
    });
  });
}

function filterData(keyword, divId, dt){
  const view=new google.visualization.DataView(dt.getDataTable());
  const rows=[];
  for(let i=0;i<dt.getDataTable().getNumberOfRows();i++){
    for(let j=0;j<dt.getDataTable().getNumberOfColumns();j++){
      const v=dt.getDataTable().getValue(i,j);
      if(v && v.toString().toLowerCase().includes(keyword.toLowerCase())){
        rows.push(i); break;
      }
    }
  }
  view.setRows(rows);
  drawTable(view, divId);
}

function drawTable(dt, divId){
  const t=new google.visualization.Table(document.getElementById(divId));
  google.visualization.events.addListener(t,'ready',function(){
    const rows=document.querySelectorAll(`#${divId} table tbody tr`);
    rows.forEach(r=>{
      const c=r.querySelectorAll('td');
      if(c.length<8) return;
      const daLap=c[5]?.innerText.trim()==='1';
      const daTich=c[6]?.innerText.trim()==='1';
      if(daLap&&!daTich) r.style.background='#fff6a3';
      if(daLap&&daTich) r.style.background='#d1eaff';
      const lat=c[c.length-2]?.innerText;
      const lon=c[c.length-1]?.innerText;
      const tram=c[0]?.innerText;
      if(lat&&lon&&!isNaN(parseFloat(lat))){
        const mapCell=c[c.length-3];
        mapCell.innerHTML=`<a href="https://www.google.com/maps?q=${lat},${lon} (${tram})" target="_blank">Bản đồ</a>`;
      }
      c[c.length-1].style.display='none';
      c[c.length-2].style.display='none';
    });
  });
  t.draw(dt,{showRowNumber:true,width:'100%',allowHtml:true,page:'enable',pageSize:20});
}

// Tổng hợp
function buildSummary(type){
  if(!sheetData) return;
  const dt=sheetData.getDataTable();
  const groupCol=(type==='Huyện')?0:1;
  const sum={};
  for(let i=0;i<dt.getNumberOfRows();i++){
    const key=dt.getValue(i,groupCol)||'Không xác định';
    const daLap=dt.getValue(i,5)==='1'||dt.getValue(i,5)===1;
    const daTich=dt.getValue(i,6)==='1'||dt.getValue(i,6)===1;
    if(!sum[key]) sum[key]={tong:0,lap:0,tich:0};
    sum[key].tong++;
    if(daLap) sum[key].lap++;
    if(daTich) sum[key].tich++;
  }
  let html=`<table border=1 cellpadding=5><tr><th>${type}</th><th>Tổng</th><th>Đã lắp</th><th>Đã tích hợp</th><th>% Lắp</th><th>% Tích hợp</th></tr>`;
  for(const [k,v] of Object.entries(sum)){
    html+=`<tr><td>${k}</td><td>${v.tong}</td><td>${v.lap}</td><td>${v.tich}</td><td>${((v.lap/v.tong)*100).toFixed(1)}%</td><td>${((v.tich/v.tong)*100).toFixed(1)}%</td></tr>`;
  }
  html+='</table>';
  document.getElementById('tong_div').innerHTML=html;
}
</script>
</body>
</html>
