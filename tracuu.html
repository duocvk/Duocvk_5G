<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tra cứu Trạm 5G - Fixed Header & Reset</title>
<style>
:root{--blue:#0078d7;--yellow:#fff6a3;--green:#d1eaff}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f7f9fc}
header{background:var(--blue);color:#fff;text-align:center;padding:12px;font-size:18px;font-weight:700}
.wrap{max-width:1200px;margin:16px auto;padding:0 12px}
.card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
nav button{padding:8px 14px;border-radius:6px;border:1px solid #ddd;cursor:pointer;background:#fff}
nav button.active{background:var(--blue);color:#fff;border-color:var(--blue)}
input,select{padding:8px;border-radius:6px;border:1px solid #ccc}
#suggestions,#suggestionsCalloff{position:absolute;background:#fff;border:1px solid #ddd;z-index:999;width:320px;max-height:200px;overflow:auto}
#suggestions div,#suggestionsCalloff div{padding:6px;cursor:pointer}
#suggestions div:hover,#suggestionsCalloff div:hover{background:#eef8ff}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{border:1px solid #e6eaf0;padding:6px;text-align:left}
th{background:#f1f4ff}
tr.row-installed{background:var(--yellow)!important}
tr.row-integrated{background:var(--green)!important}
.small-btn{padding:6px 10px;border:none;border-radius:6px;background:var(--blue);color:#fff;cursor:pointer}
.ghost{background:#fff;color:var(--blue);border:1px solid #cfd8e3}
.modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.3)}
.modal{background:#fff;padding:18px;border-radius:8px;min-width:300px}
.modal input{width:100%;margin:5px 0;padding:8px;border:1px solid #ccc;border-radius:6px}
.modal button{margin-top:8px;padding:8px 12px;border:none;border-radius:6px;background:var(--blue);color:#fff}
</style>
</head>
<body>
<header>TRA CỨU TRẠM 5G</header>

<div class="wrap">
<div id="appArea" class="card" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <nav>
      <button class="active" onclick="showTab('chung',this)">Tra cứu chung</button>
      <button onclick="showTab('calloff',this)">Tra cứu Calloff</button>
      <button onclick="showTab('tong',this)">Tổng hợp</button>
    </nav>
    <button class="ghost" onclick="logout()">Đăng xuất</button>
  </div>

  <!-- Tab Chung -->
  <div id="tab-chung">
    <h3>Tra cứu chung</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;position:relative">
      <input id="inputChung" type="text" placeholder="Gõ mã trạm / cụm / huyện...">
      <div id="suggestions"></div>
      <select id="drop_huyen_chung"><option value="">--Huyện--</option></select>
      <select id="drop_cum_chung"><option value="">--Cụm--</option></select>
      <select id="drop_tram_chung"><option value="">--Trạm--</option></select>
      <button class="small-btn" onclick="resetChung()">Reset</button>
    </div>
    <div id="table_chung"></div>
  </div>

  <!-- Tab Calloff -->
  <div id="tab-calloff" style="display:none">
    <h3>Tra cứu Calloff</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;position:relative">
      <select id="drop_tram_calloff"><option value="">--Trạm (A)--</option></select>
      <select id="drop_huyen_calloff"><option value="">--Huyện (Q)--</option></select>
      <input id="inputCalloff" type="text" placeholder="Tìm trạm trong Calloff...">
      <div id="suggestionsCalloff"></div>
      <button class="small-btn" onclick="resetCalloff()">Reset</button>
    </div>
    <div id="table_calloff"></div>
  </div>

  <!-- Tab Tổng hợp -->
  <div id="tab-tong" style="display:none">
    <h3>Tổng hợp</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
      <button class="small-btn" onclick="renderSummary('huyen')">Theo Huyện</button>
      <button class="small-btn" onclick="renderSummary('cum')">Theo Cụm</button>
    </div>
    <div id="summary-area"></div>
    <div id="summary-detail" style="margin-top:10px"></div>
  </div>
</div>
</div>

<!-- Login -->
<div id="loginModal" class="modal-backdrop">
  <div class="modal">
    <h3>Đăng nhập</h3>
    <input id="login_user" type="text" placeholder="Tài khoản (admin)">
    <input id="login_pass" type="password" placeholder="Mật khẩu (123456)">
    <button onclick="loginSubmit()">Đăng nhập</button>
    <p id="loginError" style="color:red"></p>
  </div>
</div>

<script>
const SHEET_ID='1Oc1rFENKMMuwG7XqqIm_MAlDi2Hkvi77m1ex5mC0N-8';
const URL_SHEET=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=sheet`;
const URL_CALLOFF=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=calloff`;

const IDX={sheet:{huyen:0,cum:1,tram:2,lap:5,tich:6,lat:9,lng:10},calloff:{tram:0,huyenQ:16}};
let sheetData=[],calloffData=[];

window.onload=()=>{if(localStorage.tc_login==='1'){document.getElementById('appArea').style.display='block';init();}};

function loginSubmit(){
  const u=document.getElementById('login_user').value,p=document.getElementById('login_pass').value;
  if(u==='admin'&&p==='123456'){localStorage.tc_login='1';document.getElementById('loginModal').style.display='none';document.getElementById('appArea').style.display='block';init();}
  else document.getElementById('loginError').textContent='Sai tài khoản hoặc mật khẩu';
}
function logout(){localStorage.removeItem('tc_login');location.reload();}

async function init(){
  const s=await fetchSheet(URL_SHEET),c=await fetchSheet(URL_CALLOFF);
  sheetData=s;calloffData=c;
  setupChung();setupCalloff();renderSummary('huyen');
}

// Tự động tìm dòng header đầu tiên có dữ liệu
async function fetchSheet(url){
  const res=await fetch(url);const txt=await res.text();
  const json=JSON.parse(txt.replace(/^[^\(]*\(/,'').replace(/\);\s*$/,''));
  const rows=json.table.rows.map(r=>(r.c||[]).map(c=>c?c.v:''));
  // tìm header dòng đầu có dữ liệu
  let headerRow=0;for(let i=0;i<rows.length;i++){if(rows[i].some(v=>v!=="")){headerRow=i;break;}}
  const header=rows[headerRow];const data=[header,...rows.slice(headerRow+1)];
  return data;
}

// Tra cứu chung
function setupChung(){
  fillSelectByUnique(sheetData,IDX.sheet.huyen,'#drop_huyen_chung','--Huyện--');
  fillSelectByUnique(sheetData,IDX.sheet.cum,'#drop_cum_chung','--Cụm--');
  fillSelectByUnique(sheetData,IDX.sheet.tram,'#drop_tram_chung','--Trạm--');
  document.getElementById('inputChung').oninput=e=>autocomplete(e,'#suggestions',sheetData);
  document.querySelectorAll('#drop_huyen_chung,#drop_cum_chung,#drop_tram_chung').forEach(sel=>{
    sel.onchange=()=>{const v=sel.value;if(v)filterChung(v);else drawChung(sheetData.slice(1));};
  });
  drawChung(sheetData.slice(1));
}
function autocomplete(e,boxId,data){
  const q=e.target.value.toLowerCase().trim();const box=document.querySelector(boxId);box.innerHTML='';
  if(!q)return;
  const found=new Set();
  data.slice(1).forEach(r=>{r.forEach(v=>{if(v&&String(v).toLowerCase().includes(q))found.add(v);});});
  Array.from(found).slice(0,20).forEach(v=>{
    const d=document.createElement('div');d.textContent=v;
    d.onclick=()=>{e.target.value='';box.innerHTML='';filterChung(v);};
    box.appendChild(d);
  });
}
function filterChung(key){
  const f=sheetData.slice(1).filter(r=>r.some(v=>String(v).includes(key)));
  drawChung(f);
}
function drawChung(rows){
  const h=sheetData[0],lat=IDX.sheet.lat,lng=IDX.sheet.lng;
  let html='<table><thead><tr>';
  h.forEach((v,i)=>{if(i!==lat&&i!==lng)html+=`<th>${v||''}</th>`;});
  html+='<th>Bản đồ</th></tr></thead><tbody>';
  rows.forEach(r=>{
    const lap=r[IDX.sheet.lap],tich=r[IDX.sheet.tich];
    const cls=lap==1&&tich==1?'row-integrated':lap==1?'row-installed':'';
    html+=`<tr class="${cls}">`;
    h.forEach((_,i)=>{if(i!==lat&&i!==lng)html+=`<td>${r[i]||''}</td>`;});
    const latv=r[lat],lngv=r[lng],tram=r[IDX.sheet.tram];
    html+=latv&&lngv?`<td><a target="_blank" href="https://www.google.com/maps?q=${latv},${lngv} (${tram})">Xem</a></td>`:'<td></td>';
    html+='</tr>';
  });
  html+='</tbody></table>';
  document.getElementById('table_chung').innerHTML=html;
}
function resetChung(){
  document.querySelectorAll('#inputChung,#drop_huyen_chung,#drop_cum_chung,#drop_tram_chung').forEach(el=>el.value='');
  drawChung(sheetData.slice(1));
}

// Calloff
function setupCalloff(){
  fillSelectByUnique(calloffData,IDX.calloff.tram,'#drop_tram_calloff','--Trạm (A)--');
  fillSelectByUnique(calloffData,IDX.calloff.huyenQ,'#drop_huyen_calloff','--Huyện (Q)--');
  document.getElementById('inputCalloff').oninput=e=>autocomplete(e,'#suggestionsCalloff',calloffData);
  document.querySelectorAll('#drop_tram_calloff,#drop_huyen_calloff').forEach(sel=>{
    sel.onchange=()=>{const v=sel.value;if(v)filterCalloff(v);else drawCalloff(calloffData.slice(1));};
  });
  drawCalloff(calloffData.slice(1));
}
function filterCalloff(key){
  const f=calloffData.slice(1).filter(r=>r.some(v=>String(v).includes(key)));
  drawCalloff(f);
}
function drawCalloff(rows){
  const h=calloffData[0];
  let html='<table><thead><tr>'+h.map(v=>`<th>${v}</th>`).join('')+'</tr></thead><tbody>';
  rows.forEach(r=>{html+='<tr>'+h.map((_,i)=>`<td>${r[i]||''}</td>`).join('')+'</tr>';});
  html+='</tbody></table>';
  document.getElementById('table_calloff').innerHTML=html;
}
function resetCalloff(){
  document.querySelectorAll('#inputCalloff,#drop_tram_calloff,#drop_huyen_calloff').forEach(el=>el.value='');
  drawCalloff(calloffData.slice(1));
}

// Tổng hợp
function renderSummary(mode){
  const groupCol=mode==='huyen'?IDX.sheet.huyen:IDX.sheet.cum;
  const map=new Map();
  sheetData.slice(1).forEach(r=>{
    const k=r[groupCol]||'(Trống)';
    if(!map.has(k))map.set(k,{total:0,lap:0,tich:0});
    const o=map.get(k);o.total++;
    if(r[IDX.sheet.lap]==1)o.lap++;
    if(r[IDX.sheet.tich]==1)o.tich++;
  });
  let html='<table><thead><tr><th>'+ (mode==='huyen'?'Huyện':'Cụm') +'</th><th>Tổng</th><th>Đã lắp</th><th>Đã tích hợp</th><th>% Lắp</th><th>% Tích</th></tr></thead><tbody>';
  for(const [k,v]of map.entries()){
    const pl=Math.round(v.lap*100/v.total||0),pt=Math.round(v.tich*100/v.total||0);
    html+=`<tr><td>${k}</td><td>${v.total}</td><td>${v.lap}</td><td>${v.tich}</td><td>${pl}%</td><td>${pt}%</td></tr>`;
  }
  html+='</tbody></table>';
  document.getElementById('summary-area').innerHTML=html;
}

// Helper
function fillSelectByUnique(rows,col,selector,ph){
  const s=new Set();rows.slice(1).forEach(r=>{const v=r[col];if(v)s.add(v);});
  const el=document.querySelector(selector);el.innerHTML=`<option value="">${ph}</option>`;Array.from(s).sort().forEach(v=>el.innerHTML+=`<option>${v}</option>`);
}
function showTab(tab,btn){
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  document.getElementById('tab-chung').style.display=tab==='chung'?'':'none';
  document.getElementById('tab-calloff').style.display=tab==='calloff'?'':'none';
  document.getElementById('tab-tong').style.display=tab==='tong'?'':'none';
}
</script>
</body>
</html>
